# セキュリティレビュー対応レポート（PM向け）

対象: DreamCore-V2-sandbox
レビュー実施者: kinopiee
回答日: 2026-02-01

---

## このドキュメントについて

外部のセキュリティ専門家から、DreamCore-V2-sandbox のコードについてセキュリティ上の問題点が指摘されました。このドキュメントでは、各指摘の内容を平易な言葉で説明し、どのように対処するかをまとめています。

---

## 重要度の説明

| 重要度 | 意味 |
|--------|------|
| **P0（リリースブロッカー）** | リリース前に必ず対応が必要。対応しないとサービス停止や情報漏洩のリスクがある |
| **P1（リリース前対応）** | リリース前に対応すべき。機能が壊れたり、セキュリティが弱くなる可能性がある |
| **P2/P3（リリース後対応）** | リリース後でも対応可能。品質向上のための改善項目 |

---

## P0: リリースブロッカー（9件）

### 1. AI実行環境が安全に隔離されていない

**何が問題か？**

ユーザーがゲームを作るとき、裏でAI（Claude）がコードを書いています。このAIは本来「安全な隔離された部屋（サンドボックス）」の中で動くべきですが、一部の機能ではその部屋の外で動いていました。

もしAIが悪意のある指示を受けた場合、サーバー上の機密情報を読み取られる可能性がありました。

**どう対処する？**

- すべてのAI実行を「Modal Sandbox」という隔離環境に統一します
- 本番環境では、隔離環境なしでの実行を完全に禁止します
- 隔離環境が動かない場合は、エラーを返して処理を止めます（安全側に倒す）

**対応状況:** 対応予定

---

### 2. ファイルパス操作で外部ファイルにアクセスできる

**何が問題か？**

ファイル名に `../` という特殊な文字を入れると、本来アクセスできないはずのフォルダにアクセスできてしまう可能性がありました（パストラバーサル攻撃）。

例えば、ユーザーのプロジェクトフォルダの外にある設定ファイルを読まれる可能性がありました。

**どう対処する？**

- ファイル操作の前に、アクセス先が許可された範囲内かチェックします
- `../` などの危険なパターンを含むリクエストは拒否します

**対応状況:** 対応予定

---

### 3. リクエスト回数の制限がない

**何が問題か？**

同じユーザーが短時間に大量のリクエストを送っても、制限する仕組みがありませんでした。

これにより：
- 悪意のあるユーザーがサーバーに負荷をかけられる
- AI利用料金が異常に高額になる可能性がある

**どう対処する？**

- 1分間あたりのリクエスト数を制限します
  - 通常のAPI: 60回/分
  - AI生成系のAPI: 5回/分（コストが高いため）

**対応状況:** 対応予定

---

### 4. 接続したまま認証しない攻撃ができる

**何が問題か？**

WebSocket（リアルタイム通信）に接続した後、ログイン情報を送らずにずっと接続を維持できました。

悪意のあるユーザーが大量の接続を維持すると、サーバーのリソースを使い果たしてサービスが止まる可能性がありました（DoS攻撃）。

**どう対処する？**

- 接続後10秒以内にログイン情報を送らない場合、自動的に切断します

**対応状況:** 対応予定

---

### 5. ゲームのファイルが盗み見られる可能性

**何が問題か？**

ゲームの画像やJSファイルなどのサブリソースにアクセスする際、「どこから来たか（Referer）」という情報だけで許可していました。この情報は偽装できるため、本来見られないはずのファイルにアクセスできる可能性がありました。

**どう対処する？**

現状維持とします（リスク受容）。

**理由:**
- ゲーム本体（index.html）には厳格な認証が必要
- 画像やJSだけ取得しても、完全なゲームは再現できない
- 全ファイルに認証を必須にすると、開発コストが大幅に増加する

---

### 6. SVG画像でスクリプト攻撃ができる

**何が問題か？**

SVG画像ファイルの中には、JavaScriptコードを埋め込むことができます。悪意のあるSVGをアップロードされると、他のユーザーがその画像を見たときにスクリプトが実行される可能性がありました（XSS攻撃）。

**どう対処する？**

- SVGファイルをアップロードする際に、危険なスクリプトを自動的に削除します（サニタイズ）
- 配信時にセキュリティヘッダーを追加します

**対応状況:** 対応予定

---

### 7. ファイル種類のチェックが甘い

**何が問題か？**

ファイルをアップロードする際、「拡張子」か「ファイル形式」のどちらか一方が合っていれば許可していました。

例えば、実際はプログラムファイルなのに `.jpg` という拡張子をつけてアップロードできる可能性がありました。

**どう対処する？**

- 拡張子とファイル形式の両方が一致している場合のみ許可します

**対応状況:** 対応予定

---

### 8. 設定ミスで認証が壊れる可能性

**何が問題か？**

環境設定で「https://example.com/」のように末尾にスラッシュがあると、認証システムが正しく動かなくなる可能性がありました。

**どう対処する？**

- 設定値を読み込む際に、末尾のスラッシュを自動的に削除します

**対応状況:** 対応予定

---

### 9. 公開範囲の確認

**何が問題か？**

以下の情報が認証なしで取得できることが意図的かどうか確認が必要でした：
- プロジェクトのサムネイル画像
- ユーザーのプロフィール情報
- アップロードしたアセット（画像など）

**確認結果:**

| 項目 | 判断 | 理由 |
|------|------|------|
| サムネイル画像 | **意図的** | SNSでシェアしたときにプレビュー画像を表示するため |
| ユーザー情報 | **意図的** | ゲーム作者のプロフィールを表示するため |
| アセット | **現状維持** | ゲーム公開時に必要。将来的にUI改善を検討 |

---

## P1: リリース前対応（5件 + 未実装機能2件）

### 10. サーバー状態のチェックが不正確

**問題:** サーバーの健康状態をチェックする仕組みで、一部のエラーを見逃していました。
**対処:** エラー判定を厳格にします。

---

### 11. サムネイル生成でエラーが起きる

**問題:** サムネイル生成時に、必要なコンポーネントが準備できていないとエラーになりました。
**対処:** 使用前に準備完了を確認します。

---

### 12. サムネイルの形式変換ミス

**問題:** PNG画像をWebP形式として保存しており、表示が崩れる可能性がありました。
**対処:** 保存前に正しい形式に変換します。

---

### 13-14. Remix機能のバグ（2件）→ 対象外

**注記:** Remix機能（他のユーザーのゲームをコピーする機能）はまだ実装されていません。この指摘はコード上に存在する未使用の機能に関するものです。

**対処:** Remix機能を実装する際に一緒に対応します。現時点では対応不要です。

---

### 15. セキュリティヘッダーがない

**問題:** ブラウザに対してセキュリティ設定を伝えるヘッダーが設定されていませんでした。
**対処:** helmet というセキュリティライブラリを導入します。

---

### 16. AIへの悪意ある指示対策

**問題:** ユーザーがAIに悪意のある指示を送ると、意図しない動作をする可能性がありました（プロンプトインジェクション）。
**対処:**
- ユーザー入力とシステム指示を明確に分離します
- 疑わしい入力パターンを記録して監視します

---

## P2/P3: リリース後対応（9件）

以下は品質向上のための改善項目です。リリース後に順次対応します。

| 項目 | 概要 |
|------|------|
| 分析スクリプトのエラー対策 | データがない場合のエラー防止 |
| 画像キャッシュの修正 | 一部の画像形式で参照エラー |
| 検索機能の改善 | 大量データでの検索漏れ防止 |
| 認証方式の統一 | コードの整理・簡素化 |
| エラーメッセージの修正 | 表示内容と実際の動作を一致させる |
| チャット表示のセキュリティ | 表示時のスクリプト対策 |
| 削除機能の改善 | 削除した名前の再利用 |
| 不要な依存関係の削除 | コードの整理 |
| 未実装機能の整理 | TODO コメントの解消 |

---

## 対応スケジュール

### リリース前に必須

| 項目 | 優先度 |
|------|--------|
| AI実行環境の隔離 | 最優先 |
| ファイルパス攻撃対策 | 最優先 |
| リクエスト制限 | 最優先 |
| 接続タイムアウト | 最優先 |
| ファイル種類チェック | 最優先 |
| 設定値の正規化 | 最優先 |
| SVGサニタイズ | 高 |
| セキュリティヘッダー | 高 |
| Modal healthCheck修正 | 高 |
| サムネイル関連修正 | 高 |
| プロンプトインジェクション対策 | 高 |

### Remix機能実装時に対応

| 項目 | 備考 |
|------|------|
| Remix関連のバグ（2件） | 機能が未実装のため、実装時に対応 |

### リリース後に対応

- P2/P3の全項目

---

## まとめ

- **重大な問題が9件**見つかりました（P0）
- すべてリリース前に対応する予定です
- 一部の項目は「意図的な仕様」として確認が取れました
- P2/P3の9件はリリース後に順次対応します

---

*このドキュメントは技術的な詳細を省略しています。詳細な技術対応については `REVIEW_RESPONSE.md` を参照してください。*
