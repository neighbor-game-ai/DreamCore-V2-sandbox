# ゲーム生成フロー

## 概要

ユーザーのチャットメッセージからゲームを生成するまでの処理フロー。

---

## 全体フロー

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   ユーザー   │────▶│   サーバー   │────▶│  Gemini API │────▶│  ファイル   │
│  メッセージ  │     │  処理開始   │     │  コード生成  │     │   書き込み  │
└─────────────┘     └─────────────┘     └─────────────┘     └─────────────┘
                           │                   │
                           ▼                   ▼
                    ┌─────────────┐     ┌─────────────┐
                    │ スキル選択  │     │ 画像生成    │
                    │ (AI判定)    │     │ (2Dのみ)    │
                    └─────────────┘     └─────────────┘
```

---

## プロンプトファイル構成

### ファイル一覧

| ファイル | 役割 | 使用タイミング |
|---------|------|---------------|
| [baseRules.js](../server/prompts/baseRules.js) | デザイン・コーディング規約 | 常に使用 |
| [createPrompt.js](../server/prompts/createPrompt.js) | 新規作成用プロンプト | 新規ゲーム作成時 |
| [updatePrompt.js](../server/prompts/updatePrompt.js) | 更新用プロンプト | 既存ゲーム修正時 |
| [SYSTEM_PROMPT.md](../.claude/SYSTEM_PROMPT.md) | Claude CLI用マスタープロンプト | Claude CLIフォールバック時 |

### baseRules.js の内容

```
baseRules.js
├── designStyle        # KAWAIIデザイン規約 (カラー、形状、マテリアル)
├── codingRules        # HTML5/CSS/JS、CDN読み込み、モバイル対応
├── gameDesignRules    # 直感的操作、フィードバック、即時開始
├── touchControlRules  # 仮想ジョイスティック、マルチタッチ
├── cameraSystemRules  # Yaw/Pitch カメラ (3D用)
├── movementRules      # カメラ相対移動 (3D用)
├── audioRules         # BGM、効果音の実装方法
├── resultScreenRules  # GSAPリザルト画面
└── prohibitions       # 禁止事項 (alert, Base64, reload等)
```

---

## 新規作成フロー

```
ユーザー: 「かわいい猫のシューティングゲームを作って」
                            │
                            ▼
┌───────────────────────────────────────────────────────────────────────────┐
│ ① インテント判定                                                          │
│    ファイル: claudeRunner.js → detectIntent()                             │
│    モデル: Claude CLI (Haiku)                                             │
│    結果: chat / edit / restore                                            │
└───────────────────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌───────────────────────────────────────────────────────────────────────────┐
│ ② 2D/3D 判定                                                              │
│    ファイル: claudeRunner.js → detectDimension()                          │
│    ロジック:                                                              │
│      • "3D" 明示 → 3d                                                     │
│      • "2D" 明示 → 2d                                                     │
│      • 不明 → ユーザーに確認                                              │
└───────────────────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌───────────────────────────────────────────────────────────────────────────┐
│ ③ スキル選択                                                              │
│    ファイル: claudeRunner.js → detectSkillsWithAI()                       │
│    モデル: Claude CLI (Haiku)                                             │
│    入力: ユーザーメッセージ + dimension                                   │
│    出力: ["p5js-setup", "kawaii-colors", ...]                             │
└───────────────────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌───────────────────────────────────────────────────────────────────────────┐
│ ④ スキル内容読み込み                                                      │
│    ファイル: claudeRunner.js → getSkillContentForGemini()                 │
│    読み込み元: .claude/skills/*/SKILL.md                                  │
│    処理:                                                                  │
│      • 優先順位でソート                                                   │
│      • 最大10スキル選択                                                   │
│      • 内容を結合 (最大15000文字)                                         │
└───────────────────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌───────────────────────────────────────────────────────────────────────────┐
│ ⑤ Gemini API 呼び出し                                                     │
│    ファイル: geminiClient.js → generateCode()                             │
│                                                                           │
│    ┌─────────────────────────────────────────────────────────────────┐    │
│    │ System Prompt (createPrompt.js → getSystemPrompt())             │    │
│    │                                                                 │    │
│    │ ┌─────────────────────────────────────────────────────────────┐ │    │
│    │ │ あなたはスマートフォン向けブラウザゲーム開発の専門家です。   │ │    │
│    │ │                                                             │ │    │
│    │ │ ${baseRules.getBaseRules()}  ← baseRules.js の全内容        │ │    │
│    │ │                                                             │ │    │
│    │ │ [出力形式]                                                  │ │    │
│    │ │ { "mode": "create", "files": [...], "images": [...] }       │ │    │
│    │ │                                                             │ │    │
│    │ │ [画像生成について - 2Dゲームのみ]                          │ │    │
│    │ │ ...                                                         │ │    │
│    │ └─────────────────────────────────────────────────────────────┘ │    │
│    └─────────────────────────────────────────────────────────────────┘    │
│                                                                           │
│    ┌─────────────────────────────────────────────────────────────────┐    │
│    │ User Message (createPrompt.js → buildRequest())                 │    │
│    │                                                                 │    │
│    │ ┌─────────────────────────────────────────────────────────────┐ │    │
│    │ │ [自動判定: 2Dゲーム (確信度: 85%)]                          │ │    │
│    │ │                                                             │ │    │
│    │ │ かわいい猫のシューティングゲームを作って                    │ │    │
│    │ │                                                             │ │    │
│    │ │ [必須ガイドライン - 以下を必ず適用すること]                 │ │    │
│    │ │ ## p5js-setup                                               │ │    │
│    │ │ (SKILL.md の内容)                                           │ │    │
│    │ │                                                             │ │    │
│    │ │ ## kawaii-colors                                            │ │    │
│    │ │ (SKILL.md の内容)                                           │ │    │
│    │ └─────────────────────────────────────────────────────────────┘ │    │
│    └─────────────────────────────────────────────────────────────────┘    │
└───────────────────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌───────────────────────────────────────────────────────────────────────────┐
│ ⑥ レスポンス処理                                                          │
│    Gemini出力例:                                                          │
│    {                                                                      │
│      "mode": "create",                                                    │
│      "files": [{ "path": "index.html", "content": "..." }],               │
│      "images": [{ "name": "cat.png", "prompt": "cute cat...", "style": "kawaii" }],│
│      "summary": "かわいい猫のシューティングゲームを作成しました"          │
│    }                                                                      │
└───────────────────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌───────────────────────────────────────────────────────────────────────────┐
│ ⑦ 画像生成 (2Dゲームのみ)                                                 │
│    ファイル: claudeRunner.js → generateProjectImages()                    │
│    処理:                                                                  │
│      • analyzeImageDirection() で向き決定 (Sonnet使用)                    │
│      • geminiClient.generateImage() で画像生成                            │
│      • マゼンタ背景除去 → 透過PNG                                         │
│      • assets/ フォルダに保存                                             │
└───────────────────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌───────────────────────────────────────────────────────────────────────────┐
│ ⑧ ファイル書き込み + Git コミット                                         │
│    ファイル: claudeRunner.js → applyGeminiResult()                        │
│    保存先: users/{visitorId}/{projectId}/                                 │
│      • index.html                                                         │
│      • assets/*.png                                                       │
└───────────────────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌───────────────────────────────────────────────────────────────────────────┐
│ ⑨ 仕様書作成 (非同期)                                                     │
│    ファイル: claudeRunner.js → createInitialSpecFromCode()                │
│    モデル: Gemini                                                         │
│    出力:                                                                  │
│      • specs/game.md (ゲーム概要)                                         │
│      • specs/mechanics.md (メカニクス)                                    │
│      • specs/progress.md (実装状況)                                       │
└───────────────────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌───────────────────────────────────────────────────────────────────────────┐
│ ⑩ 完了通知                                                                │
│    WebSocket: gameUpdated → クライアントの iframe 更新                    │
└───────────────────────────────────────────────────────────────────────────┘
```

---

## アップデートフロー

```
ユーザー: 「敵の動きをもっと速くして」
                            │
                            ▼
┌───────────────────────────────────────────────────────────────────────────┐
│ ① インテント判定                                                          │
│    結果: edit                                                             │
└───────────────────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌───────────────────────────────────────────────────────────────────────────┐
│ ② 既存データ読み込み                                                      │
│    • 現在のコード (index.html)                                            │
│    • 仕様書 (specs/*.md)                                                  │
│    • フレームワーク検出 (Three.js / P5.js)                                │
└───────────────────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌───────────────────────────────────────────────────────────────────────────┐
│ ③ スキル選択                                                              │
│    検出されたフレームワークに基づいて選択                                 │
└───────────────────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌───────────────────────────────────────────────────────────────────────────┐
│ ④ Gemini API 呼び出し                                                     │
│                                                                           │
│    ┌─────────────────────────────────────────────────────────────────┐    │
│    │ System Prompt (updatePrompt.js → getSystemPrompt())             │    │
│    │                                                                 │    │
│    │ ┌─────────────────────────────────────────────────────────────┐ │    │
│    │ │ あなたはスマートフォン向けブラウザゲーム開発の専門家です。   │ │    │
│    │ │                                                             │ │    │
│    │ │ ${baseRules.getBaseRules()}                                 │ │    │
│    │ │                                                             │ │    │
│    │ │ [最重要：ユーザー意図の判断]                                │ │    │
│    │ │ ■ chat モード（質問・確認）                                 │ │    │
│    │ │ ■ edit モード（修正依頼）                                   │ │    │
│    │ │ ■ restore モード（元に戻す）                                │ │    │
│    │ │                                                             │ │    │
│    │ │ [出力形式]                                                  │ │    │
│    │ │ editモード: { "mode": "edit", "edits": [...] }              │ │    │
│    │ │                                                             │ │    │
│    │ │ [最重要：既存仕様の維持]                                    │ │    │
│    │ │ - 依頼された内容のみ変更する                                │ │    │
│    │ └─────────────────────────────────────────────────────────────┘ │    │
│    └─────────────────────────────────────────────────────────────────┘    │
│                                                                           │
│    ┌─────────────────────────────────────────────────────────────────┐    │
│    │ User Message (updatePrompt.js → buildRequest())                 │    │
│    │                                                                 │    │
│    │ ┌─────────────────────────────────────────────────────────────┐ │    │
│    │ │ [現在のゲーム仕様 - これを維持すること]                     │ │    │
│    │ │ (specs/*.md の内容)                                         │ │    │
│    │ │                                                             │ │    │
│    │ │ [現在のコード]                                              │ │    │
│    │ │ <!DOCTYPE html>...                                          │ │    │
│    │ │                                                             │ │    │
│    │ │ [修正依頼]                                                  │ │    │
│    │ │ 敵の動きをもっと速くして                                    │ │    │
│    │ │                                                             │ │    │
│    │ │ [必須ガイドライン]                                          │ │    │
│    │ │ (選択されたスキル内容)                                      │ │    │
│    │ └─────────────────────────────────────────────────────────────┘ │    │
│    └─────────────────────────────────────────────────────────────────┘    │
└───────────────────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌───────────────────────────────────────────────────────────────────────────┐
│ ⑤ レスポンス処理                                                          │
│    Gemini出力例:                                                          │
│    {                                                                      │
│      "mode": "edit",                                                      │
│      "edits": [{                                                          │
│        "path": "index.html",                                              │
│        "old_string": "const ENEMY_SPEED = 2;",                            │
│        "new_string": "const ENEMY_SPEED = 5;"                             │
│      }],                                                                  │
│      "summary": "敵の移動速度を2から5に上げました"                        │
│    }                                                                      │
└───────────────────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌───────────────────────────────────────────────────────────────────────────┐
│ ⑥ 差分適用                                                                │
│    各 edit の old_string を new_string に置換                             │
└───────────────────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌───────────────────────────────────────────────────────────────────────────┐
│ ⑦ 仕様書更新 (非同期)                                                     │
│    ファイル: claudeRunner.js → updateSpec()                               │
│    処理:                                                                  │
│      • detectRelevantSpecs() で更新対象判定                               │
│      • 例: 「敵の動き」→ mechanics.md, progress.md                        │
└───────────────────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌───────────────────────────────────────────────────────────────────────────┐
│ ⑧ 完了通知                                                                │
└───────────────────────────────────────────────────────────────────────────┘
```

---

## モード別レスポンス形式

### create モード (新規作成)

```json
{
  "mode": "create",
  "files": [
    { "path": "index.html", "content": "<!DOCTYPE html>..." }
  ],
  "images": [
    { "name": "player.png", "prompt": "cute cat...", "style": "kawaii" }
  ],
  "summary": "ゲームを作成しました"
}
```

### edit モード (修正)

```json
{
  "mode": "edit",
  "edits": [
    {
      "path": "index.html",
      "old_string": "既存のコード",
      "new_string": "新しいコード"
    }
  ],
  "images": [],
  "summary": "修正しました"
}
```

### chat モード (会話)

```json
{
  "mode": "chat",
  "message": "質問への回答です。",
  "suggestions": ["改善案1", "改善案2"]
}
```

### restore モード (元に戻す)

```json
{
  "mode": "restore",
  "message": "直前の変更を取り消しますか？",
  "confirmLabel": "戻す",
  "cancelLabel": "キャンセル"
}
```

---

## Claude CLI フォールバック

Gemini が失敗した場合、Claude CLI (Opus) で処理:

```
┌───────────────────────────────────────────────────────────────────────────┐
│ Claude CLI 実行                                                           │
│                                                                           │
│ コマンド:                                                                 │
│ spawn('claude', [                                                         │
│   '--model', 'opus',                                                      │
│   '--verbose',                                                            │
│   '--output-format', 'stream-json',                                       │
│   '--dangerously-skip-permissions'                                        │
│ ], { cwd: projectDir })                                                   │
│                                                                           │
│ 読み込まれるファイル (Claude CLI が自動で参照):                           │
│   • .claude/SYSTEM_PROMPT.md                                              │
│   • .claude/skills/*/SKILL.md (指定されたスキル)                          │
│                                                                           │
│ stdin に書き込む内容:                                                     │
│ ┌─────────────────────────────────────────────────────────────────────┐   │
│ │ スマートフォン向けブラウザゲームを作成してください。                │   │
│ │                                                                     │   │
│ │ 作業ディレクトリ: /path/to/users/{visitorId}/{projectId}            │   │
│ │                                                                     │   │
│ │ [必須] 以下のスキルファイルを読んで適用:                            │   │
│ │ - .claude/skills/p5js-setup/SKILL.md                                │   │
│ │ - .claude/skills/kawaii-colors/SKILL.md                             │   │
│ │                                                                     │   │
│ │ ユーザーの指示: かわいい猫のシューティングゲームを作って            │   │
│ └─────────────────────────────────────────────────────────────────────┘   │
└───────────────────────────────────────────────────────────────────────────┘
```

---

## プロンプト構造まとめ

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Gemini API 呼び出し                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  System Prompt                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  createPrompt.js または updatePrompt.js の getSystemPrompt()        │   │
│  │                                                                     │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │  baseRules.js → getBaseRules()                              │   │   │
│  │  │                                                             │   │   │
│  │  │  • designStyle (KAWAII デザイン規約)                        │   │   │
│  │  │  • codingRules (コーディング規約)                           │   │   │
│  │  │  • gameDesignRules (ゲームデザイン規約)                     │   │   │
│  │  │  • touchControlRules (タッチ操作規約)                       │   │   │
│  │  │  • cameraSystemRules (3Dカメラ)                             │   │   │
│  │  │  • movementRules (3D移動)                                   │   │   │
│  │  │  • audioRules (オーディオ)                                  │   │   │
│  │  │  • resultScreenRules (リザルト画面)                         │   │   │
│  │  │  • prohibitions (禁止事項)                                  │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  │                                                                     │   │
│  │  + 出力形式の定義                                                  │   │
│  │  + モード判定ルール (updatePrompt のみ)                            │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  User Message                                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  createPrompt.js または updatePrompt.js の buildRequest()          │   │
│  │                                                                     │   │
│  │  • ユーザーメッセージ                                              │   │
│  │  • ゲームタイプ (2D/3D)                                            │   │
│  │  • 現在のコード (update時のみ)                                     │   │
│  │  • 仕様書 (specs/*.md)                                             │   │
│  │  • スキル内容 (「必須ガイドライン」として)                         │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 関連ファイルへのリンク

### プロンプトファイル
- [baseRules.js](../server/prompts/baseRules.js) - 基本ルール定義
- [createPrompt.js](../server/prompts/createPrompt.js) - 新規作成プロンプト
- [updatePrompt.js](../server/prompts/updatePrompt.js) - 更新プロンプト
- [SYSTEM_PROMPT.md](../.claude/SYSTEM_PROMPT.md) - Claude CLI用プロンプト

### 実行ファイル
- [claudeRunner.js](../server/claudeRunner.js) - メイン実行エンジン
- [geminiClient.js](../server/geminiClient.js) - Gemini API クライアント

### 解析ファイル
- [gameTypeAnalyzer.js](../server/analyzer/gameTypeAnalyzer.js) - 2D/3D 判定
- [skillSelector.js](../server/analyzer/skillSelector.js) - スキル選択

### スキルファイル
- [.claude/skills/](../.claude/skills/) - スキル定義ディレクトリ
  - [p5js-setup](../.claude/skills/p5js-setup/SKILL.md) - P5.js セットアップ
  - [threejs-setup](../.claude/skills/threejs-setup/SKILL.md) - Three.js セットアップ
  - [kawaii-colors](../.claude/skills/kawaii-colors/SKILL.md) - KAWAII カラーパレット
