# ゲームタイプ自動判定システム

## 概要

ユーザーのゲーム作成リクエストを自動分析して、2Dゲームか3Dゲームかを判定し、適切なスキルガイドラインを生成するシステムです。

## 機能

### 1. ゲームタイプ自動判定 (`gameTypeAnalyzer.js`)

#### 判定方式
- **キーワード分析**: ユーザーのメッセージから3D/2D関連キーワードを検出
- **スコアリング**: 検出されたキーワード数に基づいてスコアを計算
- **信頼度計算**: 判定の確信度を0～1の範囲で計算
- **明示的オーバーライド**: ユーザーが明確に指定した場合は確信度100%で判定

#### 3D特性キーワード
- **視点・カメラ**: 3d, 3d化, fps, tps, 立体, モデル
- **ライブラリ**: three, three.js, webgl, gpu
- **ジャンル**: マインクラフト, マイクラ, ボクセル, ダンジョン

#### 2D特性キーワード
- **ライブラリ**: p5, p5.js, canvas
- **ジャンル**: パズル, シューティング, クリッカー, マッチ3
- **操作**: タップ, クリック, ドラッグ, スクロール

#### 追加分析ロジック
検出されたキーワード以外にも以下を分析：

**3D特性**
- 一人称/三人称視点 → +3点
- 3D回転操作 → +3点
- 環境構築 → +2点
- 深度・パースペクティブ → +2点

**2D特性**
- タップ/クリック操作 → +2点
- スクロール → +2点
- パズル要素 → +2点
- シンプルデザイン → +1点

### 2. スキル推奨システム (`skillSelector.js`)

判定されたゲームタイプに基づいて、自動的に適切なスキルを推奨します。

#### 2Dゲーム推奨スキル
```
- p5js-setup      : P5.js基本セットアップ
- p5js-input      : 入力処理（キーボード・マウス）
- p5js-collision  : 当たり判定
- visual-polish-2d: 2D用ビジュアルエフェクト
```

#### 3Dゲーム推奨スキル
```
- threejs-setup    : Three.js基本セットアップ
- threejs-lighting : ライティング・シェーディング
- kawaii-3d        : KAWAII風3Dモデリング
- visual-polish-3d : 3D用ビジュアルエフェクト
```

#### 共通スキル（全ゲーム）
```
- tween-animation  : GSAP アニメーション
- particles        : パーティクルエフェクト
- game-audio       : ゲーム音声・BGM
```

### 3. プロンプト統合 (`createPrompt.js`)

ユーザーのゲーム作成リクエスト時に自動的に：

1. ゲームタイプを分析
2. 検出されたキーワードを表示
3. スキルガイドラインを自動生成
4. Gemini APIリクエストに統合

## 使用方法

### 直接利用

```javascript
const { analyzeGameType, applyExplicitOverride } = require('./gameTypeAnalyzer');
const { generateSkillGuidelines } = require('./skillSelector');

// ゲームタイプを分析
const userMessage = "マインクラフトみたいなボクセルゲーム";
const analysis = analyzeGameType(userMessage);
const result = applyExplicitOverride(userMessage, analysis);

console.log(result.gameType);      // 'game-3d'
console.log(result.confidence);    // 1.0
console.log(result.reason);        // "3Dゲームと判定（確信度: 100%）"

// スキルガイドラインを生成
const guidelines = generateSkillGuidelines(result.gameType);
```

### プロンプト統合

`createPrompt.buildRequest()` を呼び出すと自動的に分析が実行され、
以下の情報がGemini APIリクエストに追加されます：

```
[自動判定: 3Dゲーム (確信度: 100%)]
検出: ブロック, マイクラ, ボクセル, 環境構築

[必須ガイドライン]
[スキルガイドライン - 3Dゲーム]
...
```

## テストケース

実装は以下のテストケースで検証済み：

| テストケース | 入力 | 判定 | 確信度 |
|---|---|---|---|
| 2Dシューティング | シューティングゲーム | 2D | 100% |
| 3Dダンジョン | FPS風、Three.js | 3D | 100% |
| パズルゲーム | マッチ3、ドラッグ | 2D | 100% |
| クリッカー | タップ、カウンター | 2D | 100% |
| マインクラフト | ボクセル、ブロック | 3D | 100% |
| スクロールアクション | スクロール背景、キャラ | 2D | 100% |
| 明示的2D指定 | p5.js | 2D | 100% |
| 明示的3D指定 | Three.js | 3D | 100% |

## ファイル構造

```
server/
├── analyzer/
│   ├── gameTypeAnalyzer.js    # 2D/3D判定ロジック
│   ├── skillSelector.js        # スキル推奨システム
│   └── test.js                 # テストスイート
└── prompts/
    ├── createPrompt.js         # 新規ゲーム作成プロンプト（統合）
    └── updatePrompt.js         # 既存ゲーム更新プロンプト
```

## 実装のポイント

### スコアリングの設計
- 3Dキーワード1個 = 5点
- 2Dキーワード1個 = 1点
- 追加3D特性 = 2～3点
- 追加2D特性 = 1～2点

この不均等な配点により、「シューティング」のように両方に存在するキーワードも、
文脈に応じて適切に判定できます。

### 曖昧な判定の扱い
確信度が50%～80%の場合、プロンプトに「判定が曖昧」という情報を含めて、
Gemini APIに判断の自由度を与えます。

### 拡張性
新しいキーワードやジャンルを追加する場合、
`KEYWORDS_3D` / `KEYWORDS_2D` に追加するだけで対応可能です。

## 今後の改善案

1. **会話履歴の活用**: 複数のメッセージからコンテキストを学習
2. **ジャンル検出**: ゲームジャンルを自動判定して更に詳しいスキル推奨
3. **ユーザーフィードバック**: ユーザーが判定を修正した場合に学習
4. **ハイブリッドゲーム**: 2Dと3Dが混在するゲームの判定
5. **機械学習モデル**: より正確な判定のため簡単なMLモデルの導入
