# PWA / Push 通知実装 - 作業ログ

**日付:** 2026-02-05
**ステータス:** E2E テスト完了、改善項目あり

## 概要

DreamCore に PWA + Web Push 通知機能を実装。ゲーム生成完了時にブラウザを閉じていても通知を受信できるようになった。

## 実装内容

### Phase 1: PWA 基盤
- `manifest.json` - PWA マニフェスト
- `sw.js` - Service Worker（最小キャッシュ + Push ハンドラ）
- `icons/` - PWA アイコン（192/512、maskable 対応）
- HTML メタタグ追加（5ファイル）

### Phase 2: Push 通知
- DB マイグレーション: `push_subscriptions`, `notifications` テーブル
- `server/pushService.js` - web-push ラッパー
- `server/notificationService.js` - 通知作成 + Push 送信
- `server/routes/pushApi.js` - 購読管理 API
- `server/routes/notificationsApi.js` - 通知履歴 API
- `public/push.js` - フロントエンド購読モジュール

### 修正・デバッグ

| 問題 | 原因 | 対応 |
|------|------|------|
| 購読が DB に保存されない | `isSubscribed()` がブラウザ側だけチェックしていた | チェックを削除、常に subscribe 試行（UPSERT） |
| `DreamCorePush not loaded` | script defer の競合 | 動的ローダー `loadPushScript()` 追加 |
| ページリロードで購読されない | `ensurePushSubscription()` がジョブ開始時のみ呼ばれていた | 認証完了後にも呼び出し追加 |
| 新コードが読み込まれない | ブラウザキャッシュ | スクリプトにキャッシュバスター追加 |

## E2E テスト結果

| デバイス | 購読登録 | 手動通知 | ゲーム完成通知 |
|----------|---------|---------|---------------|
| Android 10 (Chrome) | ✅ | ✅ | ✅ |
| iOS 18.5 (PWA) | ✅ | ✅ | ✅ |

**注意:** iOS はおやすみモード中でも通知は届くが、表示が抑制される。

## 残っているデバッグコード

本番運用で役立つ可能性があるため残置：

- `/api/push/debug` エンドポイント（クライアント状態のサーバーログ出力）
- `ensurePushSubscription()` 内のデバッグ fetch
- VAPID/Subscribe API のログ出力

## 改善が必要な項目（バックログ）

### 1. 通知タップ時の遷移先
- **現状:** `/create.html` に遷移
- **期待:** プロジェクトページ `/create.html?project={projectId}` に遷移
- **対応箇所:** `sw.js` の `notificationclick` ハンドラ、通知ペイロードに `projectId` を含める

### 2. 通知種別ごとのリンク先
| 通知タイプ | 期待するリンク先 |
|-----------|-----------------|
| ゲーム完成 | `/create.html?project={projectId}` |
| コメント | `/play/{gameId}#comments` |
| Remix | `/create.html?project={remixProjectId}` |
| システム | `/notifications.html` |

### 3. PWA で開く（ブラウザではなく）
- **現状:** 通知タップでブラウザが開く
- **期待:** PWA がインストールされている場合は PWA で開く
- **調査:** `related_applications` + `prefer_related_applications` in manifest.json、または `clients.openWindow()` のスコープ指定

## 関連ファイル

- `/Users/admin/DreamCore-V2-sandbox/public/manifest.json`
- `/Users/admin/DreamCore-V2-sandbox/public/sw.js`
- `/Users/admin/DreamCore-V2-sandbox/public/push.js`
- `/Users/admin/DreamCore-V2-sandbox/public/app.js`
- `/Users/admin/DreamCore-V2-sandbox/server/pushService.js`
- `/Users/admin/DreamCore-V2-sandbox/server/notificationService.js`
- `/Users/admin/DreamCore-V2-sandbox/server/routes/pushApi.js`
- `/Users/admin/DreamCore-V2-sandbox/server/routes/notificationsApi.js`

## 環境変数

```
VAPID_PUBLIC_KEY=...
VAPID_PRIVATE_KEY=...
VAPID_SUBJECT=mailto:support@dreamcore.gg
PUSH_ALLOWLIST_USER_IDS=ed58dfd0-03c8-4617-ae86-f28df6f562ff  # E2Eテスト用
```
