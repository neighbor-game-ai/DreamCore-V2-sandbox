<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„É¶„Éº„Ç∂„Éº„Éó„É≠„Éï„Ç£„Éº„É´ - DreamCore</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --red: #FF3B30;
            --white: #FFFFFF;
            --gray-50: #FAFAFA;
            --gray-100: #F5F5F5;
            --gray-200: #E5E5E5;
            --gray-400: #A3A3A3;
            --gray-600: #525252;
            --gray-900: #171717;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--gray-50);
            color: var(--gray-900);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 48px 24px;
        }

        .profile-card {
            background: var(--white);
            border-radius: 24px;
            padding: 48px 32px;
            text-align: center;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.06);
        }

        .avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: var(--gray-100);
            margin: 0 auto 24px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-placeholder {
            font-size: 48px;
            color: var(--gray-400);
        }

        .display-name {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .public-id {
            font-size: 14px;
            color: var(--gray-400);
            font-family: monospace;
            margin-bottom: 24px;
        }

        .joined-date {
            font-size: 14px;
            color: var(--gray-600);
        }

        .loading {
            text-align: center;
            padding: 48px;
            color: var(--gray-400);
        }

        .error {
            text-align: center;
            padding: 48px;
            color: var(--red);
        }

        .back-link {
            display: inline-block;
            margin-top: 24px;
            color: var(--red);
            text-decoration: none;
            font-weight: 500;
        }

        .back-link:hover {
            text-decoration: underline;
        }

        .bio {
            font-size: 15px;
            color: var(--gray-600);
            line-height: 1.6;
            margin-bottom: 16px;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .social-links {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 24px;
        }

        .social-links a {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--gray-100);
            color: var(--gray-600);
            text-decoration: none;
            font-size: 16px;
            transition: background 0.2s, color 0.2s;
        }

        .social-links a:hover {
            background: var(--gray-200);
            color: var(--gray-900);
        }

        /* Skeleton loading */
        .skeleton {
            background: linear-gradient(90deg, var(--gray-100) 25%, var(--gray-50) 50%, var(--gray-100) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="content">
            <div class="profile-card">
                <div class="avatar skeleton" style="width: 120px; height: 120px;"></div>
                <div class="skeleton" style="height: 28px; width: 200px; margin: 0 auto 8px; border-radius: 8px;"></div>
                <div class="skeleton" style="height: 14px; width: 140px; margin: 0 auto; border-radius: 4px;"></div>
            </div>
        </div>
    </div>

    <script>
        (async function() {
            const pathParts = window.location.pathname.split('/');
            const userId = pathParts[2]; // /u/:id
            const contentEl = document.getElementById('content');

            // „Ç®„É©„ÉºË°®Á§∫ÔºàDOM API „Åß XSS ÂØæÁ≠ñÔºâ
            function showError(message) {
                contentEl.innerHTML = '';
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error';

                const p = document.createElement('p');
                p.textContent = message;
                errorDiv.appendChild(p);

                const link = document.createElement('a');
                link.href = '/';
                link.className = 'back-link';
                link.textContent = '„Éõ„Éº„É†„Å´Êàª„Çã';
                errorDiv.appendChild(link);

                contentEl.appendChild(errorDiv);
            }

            if (!userId) {
                showError('„É¶„Éº„Ç∂„Éº„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                return;
            }

            try {
                const response = await fetch(`/api/users/${userId}/public`);
                if (!response.ok) {
                    throw new Error('User not found');
                }

                const user = await response.json();
                const joinedDate = new Date(user.created_at).toLocaleDateString('ja-JP', {
                    year: 'numeric',
                    month: 'long'
                });

                // „Çø„Ç§„Éà„É´Êõ¥Êñ∞ÔºàtextContent „Åß XSS ÂØæÁ≠ñÔºâ
                document.title = (user.display_name || '„É¶„Éº„Ç∂„Éº') + ' - DreamCore';

                // DOM API „Åß„Éó„É≠„Éï„Ç£„Éº„É´„Ç´„Éº„ÉâÊßãÁØâÔºàXSS ÂØæÁ≠ñÔºâ
                contentEl.innerHTML = '';

                const card = document.createElement('div');
                card.className = 'profile-card';

                // „Ç¢„Éê„Çø„Éº
                const avatarDiv = document.createElement('div');
                avatarDiv.className = 'avatar';
                if (user.avatar_url) {
                    const img = document.createElement('img');
                    img.src = user.avatar_url;
                    img.alt = user.display_name || '„É¶„Éº„Ç∂„Éº';
                    avatarDiv.appendChild(img);
                } else {
                    const placeholder = document.createElement('span');
                    placeholder.className = 'avatar-placeholder';
                    placeholder.textContent = 'üë§';
                    avatarDiv.appendChild(placeholder);
                }
                card.appendChild(avatarDiv);

                // Ë°®Á§∫ÂêçÔºàtextContent „Åß XSS ÂØæÁ≠ñÔºâ
                const nameEl = document.createElement('h1');
                nameEl.className = 'display-name';
                nameEl.textContent = user.display_name || '„É¶„Éº„Ç∂„Éº';
                card.appendChild(nameEl);

                // bioÔºàÂ∞ÜÊù•Áî®„ÅÆ„Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„ÉºÔºâ
                if (user.bio) {
                    const bioEl = document.createElement('p');
                    bioEl.className = 'bio';
                    bioEl.textContent = user.bio;
                    card.appendChild(bioEl);
                }

                // SNS„É™„É≥„ÇØÔºàÂ∞ÜÊù•Áî®„ÅÆ„Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„ÉºÔºâ
                if (user.social_links) {
                    const linksDiv = document.createElement('div');
                    linksDiv.className = 'social-links';
                    linksDiv.id = 'socialLinks';

                    // URL „Çπ„Ç≠„Éº„É†Ê§úË®ºÔºàXSSÈò≤Ê≠¢Ôºâ
                    const isSafeUrl = (url) => {
                        if (!url || typeof url !== 'string') return false;
                        try {
                            const parsed = new URL(url);
                            return parsed.protocol === 'https:' || parsed.protocol === 'http:';
                        } catch {
                            return false;
                        }
                    };

                    const platforms = { x: 'ùïè', youtube: '‚ñ∂', github: '‚åò', tiktok: '‚ô™', instagram: 'üì∑' };
                    for (const [key, icon] of Object.entries(platforms)) {
                        if (user.social_links[key] && isSafeUrl(user.social_links[key])) {
                            const a = document.createElement('a');
                            a.href = user.social_links[key];
                            a.textContent = icon;
                            a.target = '_blank';
                            a.rel = 'noopener noreferrer';
                            linksDiv.appendChild(a);
                        }
                    }
                    // „Ç´„Çπ„Çø„É†„É™„É≥„ÇØ
                    if (user.social_links.custom && Array.isArray(user.social_links.custom)) {
                        for (const item of user.social_links.custom) {
                            if (isSafeUrl(item.url)) {
                                const a = document.createElement('a');
                                a.href = item.url;
                                a.textContent = item.label;
                                a.target = '_blank';
                                a.rel = 'noopener noreferrer';
                                linksDiv.appendChild(a);
                            }
                        }
                    }
                    if (linksDiv.children.length > 0) {
                        card.appendChild(linksDiv);
                    }
                }

                // Public ID
                const publicIdEl = document.createElement('p');
                publicIdEl.className = 'public-id';
                publicIdEl.textContent = user.public_id || '';
                card.appendChild(publicIdEl);

                // ÂèÇÂä†Êó•
                const joinedEl = document.createElement('p');
                joinedEl.className = 'joined-date';
                joinedEl.textContent = joinedDate + ' „Åã„ÇâÂèÇÂä†';
                card.appendChild(joinedEl);

                // Êàª„Çã„É™„É≥„ÇØ
                const backLink = document.createElement('a');
                backLink.href = '/';
                backLink.className = 'back-link';
                backLink.textContent = '‚Üê „Éõ„Éº„É†„Å´Êàª„Çã';
                card.appendChild(backLink);

                contentEl.appendChild(card);

            } catch (error) {
                showError('„É¶„Éº„Ç∂„Éº„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
            }
        })();
    </script>
</body>
</html>
