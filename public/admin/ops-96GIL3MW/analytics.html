<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>分析ダッシュボード - DreamCore 管理画面</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" media="print" onload="this.media='all'">
  <link rel="stylesheet" href="/style.css">
  <!-- Early auth check + Supabase lazy loader -->
  <script>
    (function() {
      var cached = sessionStorage.getItem('dreamcore_session_cache');
      var supabaseSession = null;
      for (var i = 0; i < localStorage.length; i++) {
        var key = localStorage.key(i);
        if (key && key.startsWith('sb-') && key.endsWith('-auth-token')) {
          supabaseSession = localStorage.getItem(key);
          break;
        }
      }
      if (!cached && !supabaseSession) { window.location.href = '/'; return; }
      if (!cached && supabaseSession) { return; }
      try {
        var data = JSON.parse(cached);
        if (Date.now() - data.timestamp > 300000) {
          sessionStorage.removeItem('dreamcore_session_cache');
          window.location.href = '/';
          return;
        }
        var session = data.session;
        if (session && session.expires_at && Date.now() / 1000 > session.expires_at - 60) {
          sessionStorage.removeItem('dreamcore_session_cache');
          window.location.href = '/';
          return;
        }
      } catch(e) {
        sessionStorage.removeItem('dreamcore_session_cache');
        window.location.href = '/';
      }
    })();
    window.__SUPABASE__ = {
      url: 'https://tcynrijrovktirsvwiqb.supabase.co',
      anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRjeW5yaWpyb3ZrdGlyc3Z3aXFiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwMjY5OTAsImV4cCI6MjA4NDYwMjk5MH0.y-_E-vuQg84t8BGISdPL18oaYcayS8ip1OLJsZwM3hI'
    };
    window.__loadSupabase = function() {
      if (window.supabase) return Promise.resolve();
      return new Promise(function(resolve) {
        var s = document.createElement('script');
        s.src = '/lib/supabase.min.js';
        s.onload = resolve;
        document.head.appendChild(s);
      });
    };
  </script>
  <style>
    /* Analytics Dashboard Styles */
    html, body {
      overflow: auto;
      height: auto;
      min-height: 100vh;
    }

    .admin-container {
      min-height: 100vh;
      padding: var(--s-24);
      max-width: 1400px;
      margin: 0 auto;
    }

    /* Header */
    .admin-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: var(--s-24);
      padding-bottom: var(--s-16);
      border-bottom: 1px solid var(--gray-200);
      flex-wrap: wrap;
      gap: var(--s-16);
    }

    .header-left {
      display: flex;
      flex-direction: column;
      gap: var(--s-8);
    }

    .admin-title {
      font-size: 1.75rem;
      font-weight: 800;
      color: var(--gray-900);
      display: flex;
      align-items: center;
      gap: var(--s-12);
    }

    .admin-badge {
      font-size: 0.625rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      padding: var(--s-4) var(--s-8);
      background: var(--red-light);
      color: var(--red);
      border-radius: var(--r-full);
    }

    .last-updated {
      font-size: 0.75rem;
      color: var(--gray-400);
    }

    .header-controls {
      display: flex;
      align-items: center;
      gap: var(--s-12);
      flex-wrap: wrap;
    }

    /* Period Selector */
    .period-selector {
      display: flex;
      background: var(--gray-100);
      border-radius: var(--r-8);
      padding: 2px;
    }

    .period-btn {
      padding: var(--s-8) var(--s-16);
      border: none;
      background: transparent;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--gray-600);
      cursor: pointer;
      border-radius: var(--r-8);
      transition: all 0.2s ease;
    }

    .period-btn:hover {
      color: var(--gray-900);
    }

    .period-btn.active {
      background: var(--white);
      color: var(--gray-900);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .custom-date-range {
      display: none;
      align-items: center;
      gap: var(--s-8);
    }

    .custom-date-range.visible {
      display: flex;
    }

    .custom-date-range input {
      padding: var(--s-8) var(--s-12);
      border: 1px solid var(--gray-200);
      border-radius: var(--r-8);
      font-size: 0.875rem;
      color: var(--gray-900);
    }

    .apply-btn {
      padding: var(--s-8) var(--s-16);
      background: var(--red);
      color: white;
      border: none;
      border-radius: var(--r-8);
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: opacity 0.2s ease;
    }

    .apply-btn:hover {
      opacity: 0.9;
    }

    .back-link {
      display: inline-flex;
      align-items: center;
      gap: var(--s-8);
      color: var(--gray-600);
      text-decoration: none;
      font-size: 0.875rem;
      padding: var(--s-8) var(--s-16);
      border-radius: var(--r-8);
      transition: all 0.2s ease;
    }

    .back-link:hover {
      background: var(--gray-100);
      color: var(--gray-900);
    }

    /* KPI Cards */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: var(--s-16);
      margin-bottom: var(--s-24);
    }

    .kpi-card {
      background: var(--white);
      border-radius: var(--r-16);
      padding: var(--s-24);
      border: 1px solid var(--gray-200);
      transition: box-shadow 0.2s ease;
    }

    .kpi-card:hover {
      box-shadow: var(--glass-shadow);
    }

    .kpi-label {
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--gray-400);
      margin-bottom: var(--s-8);
      display: flex;
      align-items: center;
      gap: var(--s-4);
    }

    .kpi-value {
      font-size: 2rem;
      font-weight: 800;
      color: var(--gray-900);
    }

    .kpi-subtitle {
      font-size: 0.75rem;
      color: var(--gray-400);
      margin-top: var(--s-4);
    }

    .kpi-description {
      font-size: 0.75rem;
      color: var(--gray-500);
      margin-top: var(--s-8);
      line-height: 1.5;
      border-top: 1px solid var(--gray-100);
      padding-top: var(--s-8);
    }

    /* Tooltip */
    .info-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: var(--gray-200);
      color: var(--gray-500);
      font-size: 0.625rem;
      font-weight: 700;
      cursor: help;
      position: relative;
    }

    .info-icon:hover .tooltip {
      display: block;
    }

    .tooltip {
      display: none;
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: var(--gray-900);
      color: white;
      padding: var(--s-8) var(--s-12);
      border-radius: var(--r-8);
      font-size: 0.75rem;
      font-weight: 400;
      text-transform: none;
      letter-spacing: normal;
      width: 220px;
      line-height: 1.5;
      z-index: 100;
      margin-bottom: var(--s-4);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .tooltip::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-top-color: var(--gray-900);
    }

    /* Section */
    .section {
      background: var(--white);
      border-radius: var(--r-16);
      margin-bottom: var(--s-24);
      border: 1px solid var(--gray-200);
      overflow: hidden;
    }

    .section-header {
      background: var(--gray-900);
      color: var(--white);
      padding: var(--s-16) var(--s-24);
      font-size: 0.875rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: var(--s-8);
    }

    .section-header .info-icon {
      background: rgba(255, 255, 255, 0.2);
      color: white;
    }

    .section-header .tooltip {
      background: white;
      color: var(--gray-900);
    }

    .section-header .tooltip::after {
      border-top-color: white;
    }

    .section-description {
      font-size: 0.75rem;
      color: var(--gray-500);
      padding: var(--s-12) var(--s-24);
      background: var(--gray-50);
      border-bottom: 1px solid var(--gray-100);
      line-height: 1.5;
    }

    .section-body {
      padding: var(--s-24);
    }

    /* DAU Chart */
    .dau-chart {
      display: flex;
      align-items: flex-end;
      gap: var(--s-8);
      height: 180px;
      padding: var(--s-16) 0;
    }

    .dau-bar-wrapper {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      height: 100%;
      min-width: 40px;
    }

    .dau-bar-value {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--gray-900);
      margin-bottom: var(--s-8);
    }

    .dau-bar-container {
      flex: 1;
      width: 100%;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
    }

    .dau-bar {
      width: 100%;
      background: var(--red);
      border-radius: var(--r-8) var(--r-8) 0 0;
      min-height: 4px;
      transition: height 0.3s ease;
    }

    .dau-bar-label {
      font-size: 0.625rem;
      color: var(--gray-400);
      text-align: center;
      margin-top: var(--s-8);
      line-height: 1.3;
    }

    /* Event Cards Grid */
    .event-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: var(--s-16);
    }

    .event-card {
      background: var(--gray-50);
      border-radius: var(--r-12);
      padding: var(--s-16);
      text-align: center;
      transition: transform 0.2s ease;
    }

    .event-card:hover {
      transform: translateY(-2px);
    }

    .event-card.error {
      background: rgba(239, 68, 68, 0.1);
    }

    .event-card.error .event-count {
      color: #EF4444;
    }

    .event-icon {
      width: 32px;
      height: 32px;
      margin: 0 auto var(--s-8);
      border-radius: var(--r-8);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .event-icon.page_view { background: rgba(59, 130, 246, 0.1); color: #3B82F6; }
    .event-icon.game_play { background: rgba(139, 92, 246, 0.1); color: #8B5CF6; }
    .event-icon.game_create { background: rgba(16, 185, 129, 0.1); color: #10B981; }
    .event-icon.game_publish { background: rgba(245, 158, 11, 0.1); color: #F59E0B; }
    .event-icon.error { background: rgba(239, 68, 68, 0.1); color: #EF4444; }

    .event-name {
      font-size: 0.75rem;
      font-weight: 500;
      color: var(--gray-600);
      margin-bottom: var(--s-4);
    }

    .event-count {
      font-size: 1.5rem;
      font-weight: 800;
      color: var(--gray-900);
    }

    .event-description {
      font-size: 0.625rem;
      color: var(--gray-500);
      margin-top: var(--s-8);
      line-height: 1.4;
      text-align: left;
    }

    /* Funnel */
    .funnel-container {
      display: flex;
      align-items: center;
      gap: var(--s-8);
    }

    .funnel-step {
      flex: 1;
      text-align: center;
    }

    .funnel-bar-container {
      position: relative;
      height: 60px;
      margin-bottom: var(--s-12);
    }

    .funnel-bar {
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      background: var(--red);
      border-radius: var(--r-8);
      transition: all 0.3s ease;
    }

    .funnel-step:nth-child(1) .funnel-bar { background: #3B82F6; }
    .funnel-step:nth-child(2) .funnel-bar { background: #8B5CF6; }
    .funnel-step:nth-child(3) .funnel-bar { background: #F59E0B; }
    .funnel-step:nth-child(4) .funnel-bar { background: #10B981; }

    .funnel-label {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--gray-900);
      margin-bottom: var(--s-4);
    }

    .funnel-count {
      font-size: 1.25rem;
      font-weight: 800;
      color: var(--gray-900);
    }

    .funnel-percent {
      font-size: 0.625rem;
      color: var(--gray-400);
    }

    .funnel-arrow {
      color: var(--gray-300);
      font-size: 1.5rem;
    }

    /* Two Column Layout */
    .two-col {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--s-24);
    }

    /* Horizontal Bar Chart */
    .hbar-chart {
      display: flex;
      flex-direction: column;
      gap: var(--s-12);
    }

    .hbar-item {
      display: flex;
      align-items: center;
      gap: var(--s-12);
    }

    .hbar-label {
      width: 80px;
      font-size: 0.75rem;
      font-weight: 500;
      color: var(--gray-600);
      flex-shrink: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .hbar-track {
      flex: 1;
      height: 24px;
      background: var(--gray-100);
      border-radius: var(--r-full);
      overflow: hidden;
    }

    .hbar-fill {
      height: 100%;
      background: var(--red);
      border-radius: var(--r-full);
      transition: width 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: var(--s-8);
    }

    .hbar-value {
      font-size: 0.75rem;
      font-weight: 600;
      color: white;
    }

    .hbar-value-outside {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--gray-600);
      margin-left: var(--s-8);
      min-width: 40px;
    }

    /* Segment Display */
    .segment-row {
      display: flex;
      align-items: center;
      gap: var(--s-16);
      padding: var(--s-12) 0;
      border-bottom: 1px solid var(--gray-100);
    }

    .segment-row:last-child {
      border-bottom: none;
    }

    .segment-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .segment-name {
      flex: 1;
      font-size: 0.875rem;
      color: var(--gray-900);
    }

    .segment-value {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--gray-900);
    }

    .segment-percent {
      font-size: 0.75rem;
      color: var(--gray-400);
      min-width: 50px;
      text-align: right;
    }

    /* Tables */
    .data-table {
      width: 100%;
      border-collapse: collapse;
    }

    .data-table th {
      text-align: left;
      font-size: 0.625rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--gray-400);
      padding: var(--s-8) var(--s-12);
      border-bottom: 1px solid var(--gray-200);
    }

    .data-table td {
      padding: var(--s-12);
      font-size: 0.875rem;
      color: var(--gray-900);
      border-bottom: 1px solid var(--gray-100);
    }

    .data-table tr:last-child td {
      border-bottom: none;
    }

    .data-table .rank {
      width: 32px;
      height: 32px;
      background: var(--gray-100);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--gray-600);
    }

    .data-table .path {
      font-family: monospace;
      font-size: 0.8125rem;
      max-width: 300px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .data-table .count {
      font-weight: 600;
      text-align: right;
    }

    /* Loading & Error States */
    .loading-state,
    .error-state {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 120px;
      color: var(--gray-400);
      font-size: 0.875rem;
    }

    .error-state {
      color: #EF4444;
      flex-direction: column;
      gap: var(--s-16);
      min-height: 50vh;
    }

    .loading-spinner {
      width: 24px;
      height: 24px;
      border: 2px solid var(--gray-200);
      border-top-color: var(--red);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .kpi-grid {
        grid-template-columns: repeat(3, 1fr);
      }
      .event-grid {
        grid-template-columns: repeat(3, 1fr);
      }
      .two-col {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      .admin-container {
        padding: var(--s-16);
      }
      .admin-header {
        flex-direction: column;
        align-items: stretch;
      }
      .header-controls {
        flex-direction: column;
        align-items: stretch;
      }
      .period-selector {
        width: 100%;
        justify-content: center;
      }
      .custom-date-range {
        flex-direction: column;
      }
      .custom-date-range input {
        width: 100%;
      }
      .kpi-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      .kpi-value {
        font-size: 1.5rem;
      }
      .event-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      .funnel-container {
        flex-direction: column;
        gap: var(--s-16);
      }
      .funnel-arrow {
        transform: rotate(90deg);
      }
      .dau-chart {
        overflow-x: auto;
      }
      .dau-bar-wrapper {
        min-width: 50px;
      }
    }

    /* Navigation Tabs */
    .admin-nav {
      display: flex;
      background: var(--gray-100);
      border-radius: var(--r-8);
      padding: 2px;
      margin-bottom: var(--s-24);
    }

    .nav-tab {
      padding: var(--s-12) var(--s-24);
      border: none;
      background: transparent;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--gray-600);
      cursor: pointer;
      border-radius: var(--r-8);
      transition: all 0.2s ease;
      text-decoration: none;
    }

    .nav-tab:hover {
      color: var(--gray-900);
    }

    .nav-tab.active {
      background: var(--white);
      color: var(--gray-900);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
  </style>
</head>
<body>
  <div class="admin-container" id="mainContainer">
    <!-- Navigation -->
    <div class="admin-nav">
      <a href="analytics.html" class="nav-tab active">概要</a>
      <a href="retention.html" class="nav-tab">リテンション</a>
    </div>

    <!-- Header -->
    <header class="admin-header">
      <div class="header-left">
        <h1 class="admin-title">
          分析ダッシュボード
          <span class="admin-badge">管理者専用</span>
        </h1>
        <p class="last-updated" id="lastUpdated">読み込み中...</p>
      </div>
      <div class="header-controls">
        <div class="period-selector">
          <button class="period-btn active" data-period="7d">7日間</button>
          <button class="period-btn" data-period="30d">30日間</button>
          <button class="period-btn" data-period="custom">カスタム</button>
        </div>
        <div class="custom-date-range" id="customDateRange">
          <input type="date" id="startDate">
          <span style="color: var(--gray-400);">~</span>
          <input type="date" id="endDate">
          <button class="apply-btn" onclick="applyCustomRange()">適用</button>
        </div>
        <a href="/create.html" class="back-link">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
          </svg>
          アプリに戻る
        </a>
      </div>
    </header>

    <!-- Loading State -->
    <div class="loading-state" id="loadingState">
      <div class="loading-spinner"></div>
    </div>

    <!-- Main Content (hidden until loaded) -->
    <div id="dashboardContent" style="display: none;">
      <!-- Overview Cards (Total counts) -->
      <div class="kpi-grid" style="grid-template-columns: repeat(4, 1fr); margin-bottom: var(--s-32);">
        <div class="kpi-card" style="background: linear-gradient(135deg, #FF3B30 0%, #FF6B5B 100%); border: none;">
          <div class="kpi-label" style="color: rgba(255,255,255,0.8);">登録ユーザー数</div>
          <div class="kpi-value" id="kpiTotalUsers" style="color: white;">-</div>
          <div class="kpi-subtitle" style="color: rgba(255,255,255,0.7);">累計</div>
        </div>
        <div class="kpi-card" style="background: linear-gradient(135deg, #3B82F6 0%, #60A5FA 100%); border: none;">
          <div class="kpi-label" style="color: rgba(255,255,255,0.8);">投稿ゲーム数</div>
          <div class="kpi-value" id="kpiTotalGames" style="color: white;">-</div>
          <div class="kpi-subtitle" style="color: rgba(255,255,255,0.7);">累計</div>
        </div>
        <div class="kpi-card" style="background: linear-gradient(135deg, #10B981 0%, #34D399 100%); border: none;">
          <div class="kpi-label" style="color: rgba(255,255,255,0.8);">本日の新規ユーザー</div>
          <div class="kpi-value" id="kpiTodayUsers" style="color: white;">-</div>
          <div class="kpi-subtitle" style="color: rgba(255,255,255,0.7);">今日</div>
        </div>
        <div class="kpi-card" style="background: linear-gradient(135deg, #F59E0B 0%, #FBBF24 100%); border: none;">
          <div class="kpi-label" style="color: rgba(255,255,255,0.8);">本日の投稿ゲーム</div>
          <div class="kpi-value" id="kpiTodayGames" style="color: white;">-</div>
          <div class="kpi-subtitle" style="color: rgba(255,255,255,0.7);">今日</div>
        </div>
      </div>

      <!-- Activity KPI Cards -->
      <div class="kpi-grid">
        <div class="kpi-card">
          <div class="kpi-label">
            DAU（本日）
            <span class="info-icon">i
              <span class="tooltip">その日に1回以上イベントを発生させたユニークユーザー数。プロダクトの日常的な利用状況を示す最も基本的な指標。</span>
            </span>
          </div>
          <div class="kpi-value" id="kpiDau">-</div>
          <div class="kpi-subtitle">日次アクティブユーザー</div>
          <div class="kpi-description">その日に1回以上イベントを発生させたユニークユーザー数。プロダクトの日常的な利用状況を示す最も基本的な指標。</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">
            WAU（今週）
            <span class="info-icon">i
              <span class="tooltip">直近7日間でアクティブだったユニークユーザー数。DAUより変動が少なく、週単位のトレンド把握に適している。</span>
            </span>
          </div>
          <div class="kpi-value" id="kpiWau">-</div>
          <div class="kpi-subtitle">週次アクティブユーザー</div>
          <div class="kpi-description">直近7日間でアクティブだったユニークユーザー数。DAUより変動が少なく、週単位のトレンド把握に適している。</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">
            MAU（今月）
            <span class="info-icon">i
              <span class="tooltip">直近30日間でアクティブだったユニークユーザー数。サービス全体の規模感を示す。DAU/MAU比率でスティッキネス（定着度）を測定可能。</span>
            </span>
          </div>
          <div class="kpi-value" id="kpiMau">-</div>
          <div class="kpi-subtitle">月次アクティブユーザー</div>
          <div class="kpi-description">直近30日間でアクティブだったユニークユーザー数。サービス全体の規模感を示す。DAU/MAU比率でスティッキネス（定着度）を測定可能。</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">
            セッション数
            <span class="info-icon">i
              <span class="tooltip">期間中に開始されたセッションの総数。1ユーザーが複数回訪問すれば複数カウント。</span>
            </span>
          </div>
          <div class="kpi-value" id="kpiSessions">-</div>
          <div class="kpi-subtitle" id="kpiSessionsPeriod">期間合計</div>
          <div class="kpi-description">期間中に開始されたセッションの総数。1ユーザーが複数回訪問すれば複数カウント。</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">
            平均滞在時間
            <span class="info-icon">i
              <span class="tooltip">セッション開始から終了までの平均時間。長いほどエンゲージメントが高い傾向。ただし放置も含まれる可能性あり。</span>
            </span>
          </div>
          <div class="kpi-value" id="kpiDuration">-</div>
          <div class="kpi-subtitle">セッションあたり</div>
          <div class="kpi-description">セッション開始から終了までの平均時間。長いほどエンゲージメントが高い傾向。ただし放置も含まれる可能性あり。</div>
        </div>
      </div>

      <!-- AI Generation Metrics -->
      <section class="section" style="margin-bottom: var(--s-32);">
        <div class="section-header">AI生成メトリクス</div>
        <div class="section-body">
          <div class="kpi-grid" style="grid-template-columns: repeat(4, 1fr);">
            <div class="kpi-card" style="background: linear-gradient(135deg, #8B5CF6 0%, #A78BFA 100%); border: none;">
              <div class="kpi-label" style="color: rgba(255,255,255,0.8);">AIリクエスト数</div>
              <div class="kpi-value" id="kpiAiRequests" style="color: white;">-</div>
              <div class="kpi-subtitle" style="color: rgba(255,255,255,0.7);">期間合計</div>
            </div>
            <div class="kpi-card" style="background: linear-gradient(135deg, #EC4899 0%, #F472B6 100%); border: none;">
              <div class="kpi-label" style="color: rgba(255,255,255,0.8);">サジェスト表示数</div>
              <div class="kpi-value" id="kpiSuggestionsShown" style="color: white;">-</div>
              <div class="kpi-subtitle" style="color: rgba(255,255,255,0.7);">期間合計</div>
            </div>
            <div class="kpi-card" style="background: linear-gradient(135deg, #14B8A6 0%, #2DD4BF 100%); border: none;">
              <div class="kpi-label" style="color: rgba(255,255,255,0.8);">サジェストクリック数</div>
              <div class="kpi-value" id="kpiSuggestionsClicked" style="color: white;">-</div>
              <div class="kpi-subtitle" style="color: rgba(255,255,255,0.7);">期間合計</div>
            </div>
            <div class="kpi-card" style="background: linear-gradient(135deg, #6366F1 0%, #818CF8 100%); border: none;">
              <div class="kpi-label" style="color: rgba(255,255,255,0.8);">サジェストクリック率</div>
              <div class="kpi-value" id="kpiSuggestionClickRate" style="color: white;">-</div>
              <div class="kpi-subtitle" style="color: rgba(255,255,255,0.7);">クリック数 / 表示数</div>
            </div>
          </div>
        </div>
      </section>

      <!-- DAU Chart -->
      <section class="section">
        <div class="section-header">日次アクティブユーザー推移</div>
        <div class="section-body">
          <div class="dau-chart" id="dauChart">
            <div class="loading-state">グラフを読み込み中...</div>
          </div>
        </div>
      </section>

      <!-- Event Counts -->
      <section class="section">
        <div class="section-header">イベント数</div>
        <div class="section-body">
          <div class="event-grid" id="eventGrid">
            <div class="event-card">
              <div class="event-icon page_view">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                  <circle cx="12" cy="12" r="3"/>
                </svg>
              </div>
              <div class="event-name">page_view</div>
              <div class="event-count" id="eventPageView">-</div>
              <div class="event-description">ページ表示回数。どのページがよく見られているかの基礎データ。</div>
            </div>
            <div class="event-card">
              <div class="event-icon game_play">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polygon points="5 3 19 12 5 21 5 3"/>
                </svg>
              </div>
              <div class="event-name">game_play</div>
              <div class="event-count" id="eventGamePlay">-</div>
              <div class="event-description">ゲームがプレイされた回数。コンテンツ消費の指標。</div>
            </div>
            <div class="event-card">
              <div class="event-icon game_create">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="12" y1="5" x2="12" y2="19"/>
                  <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
              </div>
              <div class="event-name">game_create</div>
              <div class="event-count" id="eventGameCreate">-</div>
              <div class="event-description">新規ゲームが作成された回数。コンテンツ生成の指標。</div>
            </div>
            <div class="event-card">
              <div class="event-icon game_publish">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/>
                  <polyline points="16 6 12 2 8 6"/>
                  <line x1="12" y1="2" x2="12" y2="15"/>
                </svg>
              </div>
              <div class="event-name">game_publish</div>
              <div class="event-count" id="eventGamePublish">-</div>
              <div class="event-description">ゲームが公開された回数。作成から公開への転換を示す。</div>
            </div>
            <div class="event-card" id="errorCard">
              <div class="event-icon error">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"/>
                  <line x1="15" y1="9" x2="9" y2="15"/>
                  <line x1="9" y1="9" x2="15" y2="15"/>
                </svg>
              </div>
              <div class="event-name">error</div>
              <div class="event-count" id="eventError">-</div>
              <div class="event-description">JavaScriptエラーの発生回数。0が理想。増加傾向なら調査が必要。</div>
            </div>
          </div>
        </div>
      </section>

      <!-- Funnel -->
      <section class="section">
        <div class="section-header">
          コンバージョンファネル
          <span class="info-icon">i
            <span class="tooltip">ユーザーがどの段階で離脱しているかを特定し、改善ポイントを見つけるための分析手法。</span>
          </span>
        </div>
        <div class="section-description">ファネル分析：訪問から作成、公開、プレイまでの各ステップ間の転換率を表示。どの段階でユーザーが離脱しているかを特定し、改善ポイントを見つけるために使用。</div>
        <div class="section-body">
          <div class="funnel-container" id="funnelChart">
            <div class="funnel-step">
              <div class="funnel-bar-container">
                <div class="funnel-bar" id="funnelBar0" style="width: 100%; height: 100%;"></div>
              </div>
              <div class="funnel-label">訪問</div>
              <div class="funnel-count" id="funnelCount0">-</div>
              <div class="funnel-percent" id="funnelPercent0">100%</div>
            </div>
            <div class="funnel-arrow">&#8594;</div>
            <div class="funnel-step">
              <div class="funnel-bar-container">
                <div class="funnel-bar" id="funnelBar1" style="width: 80%; height: 100%;"></div>
              </div>
              <div class="funnel-label">作成</div>
              <div class="funnel-count" id="funnelCount1">-</div>
              <div class="funnel-percent" id="funnelPercent1">-</div>
            </div>
            <div class="funnel-arrow">&#8594;</div>
            <div class="funnel-step">
              <div class="funnel-bar-container">
                <div class="funnel-bar" id="funnelBar2" style="width: 60%; height: 100%;"></div>
              </div>
              <div class="funnel-label">公開</div>
              <div class="funnel-count" id="funnelCount2">-</div>
              <div class="funnel-percent" id="funnelPercent2">-</div>
            </div>
            <div class="funnel-arrow">&#8594;</div>
            <div class="funnel-step">
              <div class="funnel-bar-container">
                <div class="funnel-bar" id="funnelBar3" style="width: 40%; height: 100%;"></div>
              </div>
              <div class="funnel-label">プレイ</div>
              <div class="funnel-count" id="funnelCount3">-</div>
              <div class="funnel-percent" id="funnelPercent3">-</div>
            </div>
          </div>
        </div>
      </section>

      <!-- Segments -->
      <div class="two-col">
        <!-- Country -->
        <section class="section">
          <div class="section-header">
            国別ユーザー
            <span class="info-icon">i
              <span class="tooltip">ユーザーの地理的分布。マーケティング施策の効果測定や、ローカライズ優先度の判断に使用。</span>
            </span>
          </div>
          <div class="section-description">ユーザーの地理的分布。マーケティング施策の効果測定や、ローカライズ優先度の判断に使用。</div>
          <div class="section-body">
            <div class="hbar-chart" id="countryChart">
              <div class="loading-state">データなし</div>
            </div>
          </div>
        </section>

        <!-- Device/OS -->
        <section class="section">
          <div class="section-header">
            デバイス / OS
            <span class="info-icon">i
              <span class="tooltip">利用環境の分布。特定環境での不具合調査や、開発優先度の判断に活用。</span>
            </span>
          </div>
          <div class="section-description">利用環境の分布。特定環境での不具合調査や、開発優先度の判断に活用。</div>
          <div class="section-body">
            <div id="deviceChart">
              <div class="loading-state">データなし</div>
            </div>
          </div>
        </section>
      </div>

      <div class="two-col">
        <!-- New vs Returning -->
        <section class="section">
          <div class="section-header">
            新規 / 既存ユーザー
            <span class="info-icon">i
              <span class="tooltip">新規ユーザー（期間中に初セッション）vs リピーター。獲得と定着のバランスを確認。</span>
            </span>
          </div>
          <div class="section-description">新規ユーザー（期間中に初セッション）vs リピーター。獲得と定着のバランスを確認。</div>
          <div class="section-body">
            <div id="newReturningChart">
              <div class="segment-row">
                <div class="segment-dot" style="background: #3B82F6;"></div>
                <div class="segment-name">新規ユーザー</div>
                <div class="segment-value" id="newUsersCount">-</div>
                <div class="segment-percent" id="newUsersPercent">-</div>
              </div>
              <div class="segment-row">
                <div class="segment-dot" style="background: #10B981;"></div>
                <div class="segment-name">既存ユーザー</div>
                <div class="segment-value" id="returningUsersCount">-</div>
                <div class="segment-percent" id="returningUsersPercent">-</div>
              </div>
            </div>
          </div>
        </section>

        <!-- Session Distribution -->
        <section class="section">
          <div class="section-header">セッション分布</div>
          <div class="section-body">
            <div id="sessionDistChart">
              <div class="loading-state">データなし</div>
            </div>
          </div>
        </section>
      </div>

      <!-- Popular Content -->
      <div class="two-col">
        <!-- Top Pages -->
        <section class="section">
          <div class="section-header">
            人気ページ
            <span class="info-icon">i
              <span class="tooltip">閲覧数が多いページ。ユーザーの関心を把握し、導線設計の参考に。</span>
            </span>
          </div>
          <div class="section-description">閲覧数が多いページ。ユーザーの関心を把握し、導線設計の参考に。</div>
          <div class="section-body">
            <table class="data-table" id="topPagesTable">
              <thead>
                <tr>
                  <th style="width: 50px;">順位</th>
                  <th>パス</th>
                  <th style="width: 80px; text-align: right;">閲覧数</th>
                </tr>
              </thead>
              <tbody id="topPagesBody">
                <tr><td colspan="3" class="loading-state">読み込み中...</td></tr>
              </tbody>
            </table>
          </div>
        </section>

        <!-- Top Games -->
        <section class="section">
          <div class="section-header">
            人気ゲーム
            <span class="info-icon">i
              <span class="tooltip">プレイ回数が多いゲーム。バイラルコンテンツの発見や、おすすめ表示に活用。</span>
            </span>
          </div>
          <div class="section-description">プレイ回数が多いゲーム。バイラルコンテンツの発見や、おすすめ表示に活用。</div>
          <div class="section-body">
            <table class="data-table" id="topGamesTable">
              <thead>
                <tr>
                  <th style="width: 50px;">順位</th>
                  <th>ゲーム</th>
                  <th style="width: 80px; text-align: right;">プレイ数</th>
                </tr>
              </thead>
              <tbody id="topGamesBody">
                <tr><td colspan="3" class="loading-state">読み込み中...</td></tr>
              </tbody>
            </table>
          </div>
        </section>
      </div>
    </div>
  </div>

  <script src="/auth.js"></script>
  <script>
    // Basic Auth credentials for admin API
    const ADMIN_BASIC_USER = 'admin';
    const ADMIN_BASIC_PASS = 'dc-ops-f1f0c1ad';
    const BASIC_AUTH_HEADER = 'Basic ' + btoa(ADMIN_BASIC_USER + ':' + ADMIN_BASIC_PASS);

    // State
    let currentPeriod = '7d';
    let analyticsData = null;

    // Period selector
    document.querySelectorAll('.period-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        const period = btn.dataset.period;
        const customRange = document.getElementById('customDateRange');

        if (period === 'custom') {
          customRange.classList.add('visible');
          // Set default dates
          const today = new Date();
          const weekAgo = new Date(today);
          weekAgo.setDate(weekAgo.getDate() - 7);
          document.getElementById('endDate').value = today.toISOString().split('T')[0];
          document.getElementById('startDate').value = weekAgo.toISOString().split('T')[0];
        } else {
          customRange.classList.remove('visible');
          currentPeriod = period;
          loadAnalytics();
        }
      });
    });

    function applyCustomRange() {
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      if (startDate && endDate) {
        currentPeriod = `custom:${startDate}:${endDate}`;
        loadAnalytics();
      }
    }

    async function loadAnalytics() {
      const loadingState = document.getElementById('loadingState');
      const dashboardContent = document.getElementById('dashboardContent');

      loadingState.style.display = 'flex';
      dashboardContent.style.display = 'none';

      try {
        let url = `/api/admin/analytics/summary?period=${encodeURIComponent(currentPeriod)}`;
        // Add Basic Auth + JWT Auth
        const session = await DreamCoreAuth.getSession();
        const response = await fetch(url, {
          headers: {
            'Authorization': BASIC_AUTH_HEADER,
            'X-Auth-Token': session?.access_token || ''
          }
        });

        if (response.status === 403) {
          document.getElementById('mainContainer').innerHTML = `
            <div class="error-state">
              <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <line x1="12" y1="8" x2="12" y2="12"/>
                <line x1="12" y1="16" x2="12.01" y2="16"/>
              </svg>
              <h2 style="font-size: 1.25rem; color: var(--gray-900);">アクセス権限がありません</h2>
              <p style="color: var(--gray-600);">このページは管理者のみアクセスできます。</p>
              <a href="/create.html" class="back-link" style="margin-top: var(--s-16);">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
                アプリに戻る
              </a>
            </div>
          `;
          return;
        }

        if (!response.ok) {
          throw new Error('分析データの読み込みに失敗しました');
        }

        analyticsData = await response.json();
        renderDashboard(analyticsData);

        loadingState.style.display = 'none';
        dashboardContent.style.display = 'block';

        const periodLabel = currentPeriod.startsWith('custom:')
          ? currentPeriod.replace('custom:', '').replace(':', ' ~ ')
          : currentPeriod === '7d' ? '7日間' : currentPeriod === '30d' ? '30日間' : currentPeriod;
        document.getElementById('lastUpdated').textContent =
          `最終更新: ${new Date().toLocaleTimeString('ja-JP')} | 期間: ${periodLabel}`;
      } catch (err) {
        console.error('分析データの読み込みに失敗:', err);
        loadingState.innerHTML = `
          <div style="text-align: center; color: var(--gray-600);">
            <p>分析データの読み込みに失敗しました</p>
            <button class="apply-btn" onclick="loadAnalytics()" style="margin-top: var(--s-16);">再試行</button>
          </div>
        `;
      }
    }

    function renderDashboard(data) {
      // Total KPIs (from kpis object)
      const kpis = data.kpis || {};
      document.getElementById('kpiTotalUsers').textContent = formatNumber(kpis.totalUsers || 0);
      document.getElementById('kpiTotalGames').textContent = formatNumber(kpis.totalGames || 0);
      document.getElementById('kpiTodayUsers').textContent = formatNumber(kpis.todayNewUsers || 0);
      document.getElementById('kpiTodayGames').textContent = formatNumber(kpis.todayNewGames || 0);

      // Activity KPIs
      document.getElementById('kpiDau').textContent = formatNumber(data.dau || 0);
      document.getElementById('kpiWau').textContent = formatNumber(data.wau || 0);
      document.getElementById('kpiMau').textContent = formatNumber(data.mau || 0);
      document.getElementById('kpiSessions').textContent = formatNumber(data.sessions || 0);
      document.getElementById('kpiDuration').textContent = formatDuration(data.avgDuration || 0);

      // AI Generation Metrics
      const aiMetrics = data.aiMetrics || {};
      document.getElementById('kpiAiRequests').textContent = formatNumber(aiMetrics.requests || 0);
      document.getElementById('kpiSuggestionsShown').textContent = formatNumber(aiMetrics.suggestionsShown || 0);
      document.getElementById('kpiSuggestionsClicked').textContent = formatNumber(aiMetrics.suggestionsClicked || 0);
      document.getElementById('kpiSuggestionClickRate').textContent = (aiMetrics.suggestionClickRate || 0) + '%';

      // DAU Chart
      renderDauChart(data.dauHistory || []);

      // Event Counts
      renderEventCounts(data.eventCounts || {});

      // Funnel
      renderFunnel(data.funnel || {});

      // Segments
      renderCountryChart(data.countries || []);
      renderDeviceChart(data.devices || []);
      renderNewReturning(data.newVsReturning || {});
      renderSessionDist(data.sessionDistribution || []);

      // Popular Content
      renderTopPages(data.topPages || []);
      renderTopGames(data.topGames || []);
    }

    function renderDauChart(history) {
      const container = document.getElementById('dauChart');

      if (!history || history.length === 0) {
        container.innerHTML = '<div class="loading-state">データがありません</div>';
        return;
      }

      const maxValue = Math.max(...history.map(d => d.count), 1);

      container.innerHTML = history.map(day => {
        const heightPercent = Math.max((day.count / maxValue) * 100, 5);
        const date = new Date(day.date);
        const dayLabel = date.toLocaleDateString('ja-JP', { weekday: 'short' });
        const dateLabel = date.toLocaleDateString('ja-JP', { month: 'numeric', day: 'numeric' });

        return `
          <div class="dau-bar-wrapper">
            <div class="dau-bar-value">${formatNumber(day.count)}</div>
            <div class="dau-bar-container">
              <div class="dau-bar" style="height: ${heightPercent}%;"></div>
            </div>
            <div class="dau-bar-label">${dayLabel}<br>${dateLabel}</div>
          </div>
        `;
      }).join('');
    }

    function renderEventCounts(counts) {
      document.getElementById('eventPageView').textContent = formatNumber(counts.page_view || 0);
      document.getElementById('eventGamePlay').textContent = formatNumber(counts.game_play || 0);
      document.getElementById('eventGameCreate').textContent = formatNumber(counts.game_create || 0);
      document.getElementById('eventGamePublish').textContent = formatNumber(counts.game_publish || 0);

      const errorCount = counts.error || 0;
      document.getElementById('eventError').textContent = formatNumber(errorCount);

      const errorCard = document.getElementById('errorCard');
      if (errorCount > 0) {
        errorCard.classList.add('error');
      } else {
        errorCard.classList.remove('error');
      }
    }

    function renderFunnel(funnel) {
      const steps = ['visit', 'create', 'publish', 'play'];
      const labels = ['訪問', '作成', '公開', 'プレイ'];
      const firstValue = funnel.visit || 1;

      steps.forEach((step, i) => {
        const count = funnel[step] || 0;
        const percent = firstValue > 0 ? ((count / firstValue) * 100).toFixed(1) : 0;
        const barWidth = firstValue > 0 ? Math.max((count / firstValue) * 100, 10) : 10;

        document.getElementById(`funnelCount${i}`).textContent = formatNumber(count);
        document.getElementById(`funnelPercent${i}`).textContent = `${percent}%`;
        document.getElementById(`funnelBar${i}`).style.width = `${barWidth}%`;
      });
    }

    function renderCountryChart(countries) {
      const container = document.getElementById('countryChart');

      if (!countries || countries.length === 0) {
        container.innerHTML = '<div class="loading-state">データなし</div>';
        return;
      }

      const maxCount = Math.max(...countries.map(c => c.count), 1);
      const colors = ['#FF3B30', '#3B82F6', '#10B981', '#F59E0B', '#8B5CF6'];

      container.innerHTML = countries.slice(0, 5).map((country, i) => {
        const barWidth = Math.max((country.count / maxCount) * 100, 15);
        return `
          <div class="hbar-item">
            <div class="hbar-label">${escapeHtml(country.name || country.code || '不明')}</div>
            <div class="hbar-track">
              <div class="hbar-fill" style="width: ${barWidth}%; background: ${colors[i % colors.length]};">
                ${barWidth > 30 ? `<span class="hbar-value">${formatNumber(country.count)}</span>` : ''}
              </div>
            </div>
            ${barWidth <= 30 ? `<span class="hbar-value-outside">${formatNumber(country.count)}</span>` : ''}
          </div>
        `;
      }).join('');
    }

    function renderDeviceChart(devices) {
      const container = document.getElementById('deviceChart');

      if (!devices || devices.length === 0) {
        container.innerHTML = '<div class="loading-state">データなし</div>';
        return;
      }

      const total = devices.reduce((sum, d) => sum + d.count, 0) || 1;
      const colors = ['#3B82F6', '#10B981', '#F59E0B', '#8B5CF6', '#EF4444'];

      container.innerHTML = devices.slice(0, 5).map((device, i) => {
        const percent = ((device.count / total) * 100).toFixed(1);
        return `
          <div class="segment-row">
            <div class="segment-dot" style="background: ${colors[i % colors.length]};"></div>
            <div class="segment-name">${escapeHtml(device.name || '不明')}</div>
            <div class="segment-value">${formatNumber(device.count)}</div>
            <div class="segment-percent">${percent}%</div>
          </div>
        `;
      }).join('');
    }

    function renderNewReturning(data) {
      const newUsers = data.new || 0;
      const returning = data.returning || 0;
      const total = newUsers + returning || 1;

      document.getElementById('newUsersCount').textContent = formatNumber(newUsers);
      document.getElementById('newUsersPercent').textContent = `${((newUsers / total) * 100).toFixed(1)}%`;
      document.getElementById('returningUsersCount').textContent = formatNumber(returning);
      document.getElementById('returningUsersPercent').textContent = `${((returning / total) * 100).toFixed(1)}%`;
    }

    function renderSessionDist(distribution) {
      const container = document.getElementById('sessionDistChart');

      if (!distribution || distribution.length === 0) {
        container.innerHTML = '<div class="loading-state">データなし</div>';
        return;
      }

      const maxCount = Math.max(...distribution.map(d => d.count), 1);

      container.innerHTML = distribution.map(item => {
        const barWidth = Math.max((item.count / maxCount) * 100, 10);
        return `
          <div class="hbar-item">
            <div class="hbar-label">${escapeHtml(item.label)}</div>
            <div class="hbar-track">
              <div class="hbar-fill" style="width: ${barWidth}%; background: var(--red);">
                ${barWidth > 30 ? `<span class="hbar-value">${formatNumber(item.count)}</span>` : ''}
              </div>
            </div>
            ${barWidth <= 30 ? `<span class="hbar-value-outside">${formatNumber(item.count)}</span>` : ''}
          </div>
        `;
      }).join('');
    }

    function renderTopPages(pages) {
      const tbody = document.getElementById('topPagesBody');

      if (!pages || pages.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" class="loading-state">データなし</td></tr>';
        return;
      }

      tbody.innerHTML = pages.slice(0, 10).map((page, i) => `
        <tr>
          <td><div class="rank">${i + 1}</div></td>
          <td class="path">${escapeHtml(page.path)}</td>
          <td class="count">${formatNumber(page.count)}</td>
        </tr>
      `).join('');
    }

    function renderTopGames(games) {
      const tbody = document.getElementById('topGamesBody');

      if (!games || games.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" class="loading-state">データなし</td></tr>';
        return;
      }

      tbody.innerHTML = games.slice(0, 10).map((game, i) => `
        <tr>
          <td><div class="rank">${i + 1}</div></td>
          <td class="path">${escapeHtml(game.title || game.id || '無題')}</td>
          <td class="count">${formatNumber(game.plays)}</td>
        </tr>
      `).join('');
    }

    // Utility functions
    function formatNumber(num) {
      if (num === null || num === undefined) return '-';
      return num.toLocaleString('ja-JP');
    }

    function formatDuration(seconds) {
      if (!seconds || seconds <= 0) return '0分 0秒';
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${mins}分 ${secs}秒`;
    }

    function escapeHtml(str) {
      if (!str) return '';
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    // Initialize
    async function init() {
      try {
        await DreamCoreAuth.initAuth();
        const isAuthed = await DreamCoreAuth.isAuthenticated();
        if (!isAuthed) {
          window.location.href = '/';
          return;
        }
        loadAnalytics();
      } catch (err) {
        console.error('認証の初期化に失敗:', err);
        window.location.href = '/';
      }
    }

    init();

    // Auto-refresh every 60 seconds
    setInterval(() => {
      if (document.visibilityState === 'visible') {
        loadAnalytics();
      }
    }, 60000);
  </script>
</body>
</html>
