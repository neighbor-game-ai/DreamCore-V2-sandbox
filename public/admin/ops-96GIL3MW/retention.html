<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>リテンション分析 - DreamCore 管理画面</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" media="print" onload="this.media='all'">
  <link rel="stylesheet" href="/style.css">
  <!-- Early auth check + Supabase lazy loader -->
  <script>
    (function() {
      var cached = sessionStorage.getItem('dreamcore_session_cache');
      var supabaseSession = null;
      for (var i = 0; i < localStorage.length; i++) {
        var key = localStorage.key(i);
        if (key && key.startsWith('sb-') && key.endsWith('-auth-token')) {
          supabaseSession = localStorage.getItem(key);
          break;
        }
      }
      if (!cached && !supabaseSession) { window.location.href = '/'; return; }
      if (!cached && supabaseSession) { return; }
      try {
        var data = JSON.parse(cached);
        if (Date.now() - data.timestamp > 300000) {
          sessionStorage.removeItem('dreamcore_session_cache');
          window.location.href = '/';
          return;
        }
        var session = data.session;
        if (session && session.expires_at && Date.now() / 1000 > session.expires_at - 60) {
          sessionStorage.removeItem('dreamcore_session_cache');
          window.location.href = '/';
          return;
        }
      } catch(e) {
        sessionStorage.removeItem('dreamcore_session_cache');
        window.location.href = '/';
      }
    })();
    window.__SUPABASE__ = {
      url: 'https://tcynrijrovktirsvwiqb.supabase.co',
      anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRjeW5yaWpyb3ZrdGlyc3Z3aXFiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwMjY5OTAsImV4cCI6MjA4NDYwMjk5MH0.y-_E-vuQg84t8BGISdPL18oaYcayS8ip1OLJsZwM3hI'
    };
    window.__loadSupabase = function() {
      if (window.supabase) return Promise.resolve();
      return new Promise(function(resolve) {
        var s = document.createElement('script');
        s.src = '/lib/supabase.min.js';
        s.onload = resolve;
        document.head.appendChild(s);
      });
    };
  </script>
  <style>
    /* Analytics Dashboard Styles */
    html, body {
      overflow: auto;
      height: auto;
      min-height: 100vh;
    }

    .admin-container {
      min-height: 100vh;
      padding: var(--s-24);
      max-width: 1400px;
      margin: 0 auto;
    }

    /* Header */
    .admin-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: var(--s-24);
      padding-bottom: var(--s-16);
      border-bottom: 1px solid var(--gray-200);
      flex-wrap: wrap;
      gap: var(--s-16);
    }

    .header-left {
      display: flex;
      flex-direction: column;
      gap: var(--s-8);
    }

    .admin-title {
      font-size: 1.75rem;
      font-weight: 800;
      color: var(--gray-900);
      display: flex;
      align-items: center;
      gap: var(--s-12);
    }

    .admin-badge {
      font-size: 0.625rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      padding: var(--s-4) var(--s-8);
      background: var(--red-light);
      color: var(--red);
      border-radius: var(--r-full);
    }

    .last-updated {
      font-size: 0.75rem;
      color: var(--gray-400);
    }

    .header-controls {
      display: flex;
      align-items: center;
      gap: var(--s-12);
      flex-wrap: wrap;
    }

    /* Navigation Tabs */
    .admin-nav {
      display: flex;
      background: var(--gray-100);
      border-radius: var(--r-8);
      padding: 2px;
      margin-bottom: var(--s-24);
    }

    .nav-tab {
      padding: var(--s-12) var(--s-24);
      border: none;
      background: transparent;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--gray-600);
      cursor: pointer;
      border-radius: var(--r-8);
      transition: all 0.2s ease;
      text-decoration: none;
    }

    .nav-tab:hover {
      color: var(--gray-900);
    }

    .nav-tab.active {
      background: var(--white);
      color: var(--gray-900);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .back-link {
      display: inline-flex;
      align-items: center;
      gap: var(--s-8);
      color: var(--gray-600);
      text-decoration: none;
      font-size: 0.875rem;
      padding: var(--s-8) var(--s-16);
      border-radius: var(--r-8);
      transition: all 0.2s ease;
    }

    .back-link:hover {
      background: var(--gray-100);
      color: var(--gray-900);
    }

    /* Section */
    .section {
      background: var(--white);
      border-radius: var(--r-16);
      margin-bottom: var(--s-24);
      border: 1px solid var(--gray-200);
      overflow: hidden;
    }

    .section-header {
      background: var(--gray-900);
      color: var(--white);
      padding: var(--s-16) var(--s-24);
      font-size: 0.875rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: var(--s-8);
    }

    .section-header .info-icon {
      background: rgba(255, 255, 255, 0.2);
      color: white;
    }

    .section-header .tooltip {
      background: white;
      color: var(--gray-900);
    }

    .section-header .tooltip::after {
      border-top-color: white;
    }

    .section-description {
      font-size: 0.75rem;
      color: var(--gray-500);
      padding: var(--s-12) var(--s-24);
      background: var(--gray-50);
      border-bottom: 1px solid var(--gray-100);
      line-height: 1.5;
    }

    .section-body {
      padding: var(--s-24);
    }

    /* Tooltip */
    .info-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: var(--gray-200);
      color: var(--gray-500);
      font-size: 0.625rem;
      font-weight: 700;
      cursor: help;
      position: relative;
    }

    .info-icon:hover .tooltip {
      display: block;
    }

    .tooltip {
      display: none;
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: var(--gray-900);
      color: white;
      padding: var(--s-8) var(--s-12);
      border-radius: var(--r-8);
      font-size: 0.75rem;
      font-weight: 400;
      text-transform: none;
      letter-spacing: normal;
      width: 280px;
      line-height: 1.5;
      z-index: 100;
      margin-bottom: var(--s-4);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .tooltip::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-top-color: var(--gray-900);
    }

    /* Day N Retention Chart */
    .retention-chart {
      display: flex;
      align-items: flex-end;
      gap: var(--s-16);
      height: 200px;
      padding: var(--s-16) 0;
    }

    .retention-bar-wrapper {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      height: 100%;
      min-width: 60px;
    }

    .retention-bar-value {
      font-size: 1rem;
      font-weight: 700;
      color: var(--gray-900);
      margin-bottom: var(--s-8);
    }

    .retention-bar-container {
      flex: 1;
      width: 100%;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
    }

    .retention-bar {
      width: 100%;
      background: linear-gradient(to top, #10B981, #34D399);
      border-radius: var(--r-8) var(--r-8) 0 0;
      min-height: 4px;
      transition: height 0.3s ease;
    }

    .retention-bar-label {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--gray-600);
      text-align: center;
      margin-top: var(--s-12);
    }

    /* Cohort Table */
    .cohort-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8125rem;
    }

    .cohort-table th {
      text-align: center;
      font-size: 0.6875rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--gray-500);
      padding: var(--s-12) var(--s-8);
      border-bottom: 1px solid var(--gray-200);
    }

    .cohort-table th:first-child {
      text-align: left;
    }

    .cohort-table td {
      padding: var(--s-8);
      text-align: center;
      border-bottom: 1px solid var(--gray-100);
    }

    .cohort-table td:first-child {
      text-align: left;
      font-weight: 500;
      color: var(--gray-700);
    }

    .cohort-table tr:last-child td {
      border-bottom: none;
    }

    .cohort-cell {
      padding: var(--s-8) var(--s-12);
      border-radius: var(--r-8);
      font-weight: 600;
    }

    .cohort-size {
      color: var(--gray-500);
      font-size: 0.75rem;
      font-weight: 400;
    }

    /* Stickiness Display */
    .stickiness-display {
      display: flex;
      align-items: center;
      gap: var(--s-32);
      padding: var(--s-16) 0;
    }

    .stickiness-main {
      text-align: center;
    }

    .stickiness-value {
      font-size: 3rem;
      font-weight: 800;
      color: var(--gray-900);
      line-height: 1;
    }

    .stickiness-label {
      font-size: 0.75rem;
      font-weight: 500;
      color: var(--gray-500);
      margin-top: var(--s-4);
    }

    .stickiness-formula {
      font-size: 0.875rem;
      color: var(--gray-400);
      margin-top: var(--s-8);
    }

    .stickiness-trend {
      flex: 1;
      display: flex;
      align-items: flex-end;
      gap: var(--s-4);
      height: 60px;
    }

    .trend-bar {
      flex: 1;
      background: var(--gray-200);
      border-radius: 2px 2px 0 0;
      min-height: 4px;
      transition: height 0.3s ease;
    }

    .trend-bar.highlight {
      background: var(--red);
    }

    /* Active User Metrics */
    .active-user-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: var(--s-16);
    }

    .active-user-card {
      background: var(--gray-50);
      border-radius: var(--r-12);
      padding: var(--s-20);
      text-align: center;
    }

    .active-user-value {
      font-size: 2rem;
      font-weight: 800;
      color: var(--gray-900);
    }

    .active-user-label {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--gray-500);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-top: var(--s-4);
    }

    /* Lifecycle Segments */
    .lifecycle-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: var(--s-12);
    }

    .lifecycle-card {
      background: var(--gray-50);
      border-radius: var(--r-12);
      padding: var(--s-16);
      text-align: center;
      border: 2px solid transparent;
      transition: all 0.2s ease;
    }

    .lifecycle-card:hover {
      transform: translateY(-2px);
    }

    .lifecycle-card.new {
      border-color: #3B82F6;
      background: rgba(59, 130, 246, 0.1);
    }

    .lifecycle-card.active {
      border-color: #10B981;
      background: rgba(16, 185, 129, 0.1);
    }

    .lifecycle-card.at-risk {
      border-color: #F59E0B;
      background: rgba(245, 158, 11, 0.1);
    }

    .lifecycle-card.dormant {
      border-color: #EF4444;
      background: rgba(239, 68, 68, 0.1);
    }

    .lifecycle-card.resurrected {
      border-color: #8B5CF6;
      background: rgba(139, 92, 246, 0.1);
    }

    .lifecycle-icon {
      width: 32px;
      height: 32px;
      margin: 0 auto var(--s-8);
      border-radius: var(--r-8);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .lifecycle-card.new .lifecycle-icon { background: #3B82F6; color: white; }
    .lifecycle-card.active .lifecycle-icon { background: #10B981; color: white; }
    .lifecycle-card.at-risk .lifecycle-icon { background: #F59E0B; color: white; }
    .lifecycle-card.dormant .lifecycle-icon { background: #EF4444; color: white; }
    .lifecycle-card.resurrected .lifecycle-icon { background: #8B5CF6; color: white; }

    .lifecycle-name {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--gray-600);
      margin-bottom: var(--s-4);
    }

    .lifecycle-count {
      font-size: 1.5rem;
      font-weight: 800;
      color: var(--gray-900);
    }

    .lifecycle-description {
      font-size: 0.625rem;
      color: var(--gray-500);
      margin-top: var(--s-8);
      line-height: 1.4;
    }

    /* Two Column Layout */
    .two-col {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--s-24);
    }

    /* Loading & Error States */
    .loading-state,
    .error-state {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 120px;
      color: var(--gray-400);
      font-size: 0.875rem;
    }

    .error-state {
      color: #EF4444;
      flex-direction: column;
      gap: var(--s-16);
      min-height: 50vh;
    }

    .loading-spinner {
      width: 24px;
      height: 24px;
      border: 2px solid var(--gray-200);
      border-top-color: var(--red);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .apply-btn {
      padding: var(--s-8) var(--s-16);
      background: var(--red);
      color: white;
      border: none;
      border-radius: var(--r-8);
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: opacity 0.2s ease;
    }

    .apply-btn:hover {
      opacity: 0.9;
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .lifecycle-grid {
        grid-template-columns: repeat(3, 1fr);
      }
      .active-user-grid {
        grid-template-columns: repeat(3, 1fr);
      }
      .two-col {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      .admin-container {
        padding: var(--s-16);
      }
      .admin-header {
        flex-direction: column;
        align-items: stretch;
      }
      .header-controls {
        flex-direction: column;
        align-items: stretch;
      }
      .lifecycle-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      .active-user-grid {
        grid-template-columns: 1fr;
      }
      .retention-chart {
        overflow-x: auto;
      }
      .retention-bar-wrapper {
        min-width: 70px;
      }
      .cohort-table {
        font-size: 0.75rem;
      }
      .stickiness-display {
        flex-direction: column;
        gap: var(--s-16);
      }
    }
  </style>
</head>
<body>
  <div class="admin-container" id="mainContainer">
    <!-- Navigation -->
    <div class="admin-nav">
      <a href="analytics.html" class="nav-tab">概要</a>
      <a href="retention.html" class="nav-tab active">リテンション</a>
    </div>

    <!-- Header -->
    <header class="admin-header">
      <div class="header-left">
        <h1 class="admin-title">
          リテンション分析
          <span class="admin-badge">管理者専用</span>
        </h1>
        <p class="last-updated" id="lastUpdated">読み込み中...</p>
      </div>
      <div class="header-controls">
        <a href="/create.html" class="back-link">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
          </svg>
          アプリに戻る
        </a>
      </div>
    </header>

    <!-- Loading State -->
    <div class="loading-state" id="loadingState">
      <div class="loading-spinner"></div>
    </div>

    <!-- Main Content (hidden until loaded) -->
    <div id="dashboardContent" style="display: none;">
      <!-- Day N Retention Chart -->
      <section class="section">
        <div class="section-header">
          Day N リテンション
          <span class="info-icon">i
            <span class="tooltip">初回訪問からN日後に再訪問したユーザーの割合。D1が低いとオンボーディングに問題、D7+が低いと継続価値に問題がある可能性。</span>
          </span>
        </div>
        <div class="section-description">初回訪問からN日後に再訪問したユーザーの割合。D1が低いとオンボーディングに問題、D7+が低いと継続価値に問題がある可能性。</div>
        <div class="section-body">
          <div class="retention-chart" id="dayRetentionChart">
            <div class="loading-state">グラフを読み込み中...</div>
          </div>
        </div>
      </section>

      <!-- Active User Trends -->
      <section class="section">
        <div class="section-header">
          アクティブユーザートレンド
          <span class="info-icon">i
            <span class="tooltip">スティッキネス（DAU/MAU）：日次でどれだけのMAUが利用しているか。20%以上が健全な目安。</span>
          </span>
        </div>
        <div class="section-description">スティッキネス（DAU/MAU）：日次でどれだけのMAUが利用しているか。20%以上が健全な目安。</div>
        <div class="section-body">
          <div class="stickiness-display">
            <div class="stickiness-main">
              <div class="stickiness-value" id="stickinessValue">-</div>
              <div class="stickiness-label">スティッキネス</div>
              <div class="stickiness-formula">DAU / MAU</div>
            </div>
            <div class="active-user-grid">
              <div class="active-user-card">
                <div class="active-user-value" id="dauValue">-</div>
                <div class="active-user-label">DAU（本日）</div>
              </div>
              <div class="active-user-card">
                <div class="active-user-value" id="wauValue">-</div>
                <div class="active-user-label">WAU（今週）</div>
              </div>
              <div class="active-user-card">
                <div class="active-user-value" id="mauValue">-</div>
                <div class="active-user-label">MAU（今月）</div>
              </div>
            </div>
          </div>
          <div style="margin-top: var(--s-16);">
            <div style="font-size: 0.75rem; color: var(--gray-500); margin-bottom: var(--s-8);">過去7日間のスティッキネス推移</div>
            <div class="stickiness-trend" id="stickinessTrend">
              <div class="loading-state">グラフを読み込み中...</div>
            </div>
          </div>
        </div>
      </section>

      <!-- Cohort Retention Table -->
      <section class="section">
        <div class="section-header">
          コホートリテンション
          <span class="info-icon">i
            <span class="tooltip">コホート分析：同じ時期に初回訪問したユーザー群の、週ごとの残存率を追跡。改善施策の効果測定に有効。</span>
          </span>
        </div>
        <div class="section-description">コホート分析：同じ時期に初回訪問したユーザー群の、週ごとの残存率を追跡。改善施策の効果測定に有効。</div>
        <div class="section-body">
          <table class="cohort-table" id="cohortTable">
            <thead>
              <tr>
                <th>コホート</th>
                <th>ユーザー数</th>
                <th>Week 0</th>
                <th>Week 1</th>
                <th>Week 2</th>
                <th>Week 3</th>
                <th>Week 4</th>
              </tr>
            </thead>
            <tbody id="cohortTableBody">
              <tr><td colspan="7" class="loading-state">読み込み中...</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- User Lifecycle Segments -->
      <section class="section">
        <div class="section-header">
          ユーザーライフサイクル
          <span class="info-icon">i
            <span class="tooltip">ユーザーライフサイクル：各セグメントの推移を見ることで、獲得・定着・離脱・復帰の健全性を判断。</span>
          </span>
        </div>
        <div class="section-description">ユーザーライフサイクル：各セグメントの推移を見ることで、獲得・定着・離脱・復帰の健全性を判断。</div>
        <div class="section-body">
          <div class="lifecycle-grid">
            <div class="lifecycle-card new">
              <div class="lifecycle-icon">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                  <circle cx="8.5" cy="7" r="4"/>
                  <line x1="20" y1="8" x2="20" y2="14"/>
                  <line x1="23" y1="11" x2="17" y2="11"/>
                </svg>
              </div>
              <div class="lifecycle-name">New</div>
              <div class="lifecycle-count" id="lifecycleNew">-</div>
              <div class="lifecycle-description">今週初訪問</div>
            </div>
            <div class="lifecycle-card active">
              <div class="lifecycle-icon">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                  <polyline points="22 4 12 14.01 9 11.01"/>
                </svg>
              </div>
              <div class="lifecycle-name">Active</div>
              <div class="lifecycle-count" id="lifecycleActive">-</div>
              <div class="lifecycle-description">今週・先週アクティブ</div>
            </div>
            <div class="lifecycle-card at-risk">
              <div class="lifecycle-icon">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                  <line x1="12" y1="9" x2="12" y2="13"/>
                  <line x1="12" y1="17" x2="12.01" y2="17"/>
                </svg>
              </div>
              <div class="lifecycle-name">At Risk</div>
              <div class="lifecycle-count" id="lifecycleAtRisk">-</div>
              <div class="lifecycle-description">先週アクティブ、今週未訪問</div>
            </div>
            <div class="lifecycle-card dormant">
              <div class="lifecycle-icon">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"/>
                  <path d="M12 6v6l4 2"/>
                </svg>
              </div>
              <div class="lifecycle-name">Dormant</div>
              <div class="lifecycle-count" id="lifecycleDormant">-</div>
              <div class="lifecycle-description">2週間以上未訪問</div>
            </div>
            <div class="lifecycle-card resurrected">
              <div class="lifecycle-icon">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="23 4 23 10 17 10"/>
                  <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
                </svg>
              </div>
              <div class="lifecycle-name">Resurrected</div>
              <div class="lifecycle-count" id="lifecycleResurrected">-</div>
              <div class="lifecycle-description">休眠から復帰</div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <script src="/auth.js"></script>
  <script>
    // Basic Auth credentials for admin API
    const ADMIN_BASIC_USER = 'admin';
    const ADMIN_BASIC_PASS = 'dc-ops-f1f0c1ad';
    const BASIC_AUTH_HEADER = 'Basic ' + btoa(ADMIN_BASIC_USER + ':' + ADMIN_BASIC_PASS);

    // State
    let retentionData = null;

    async function loadRetention() {
      const loadingState = document.getElementById('loadingState');
      const dashboardContent = document.getElementById('dashboardContent');

      loadingState.style.display = 'flex';
      dashboardContent.style.display = 'none';

      try {
        const session = await DreamCoreAuth.getSession();
        const response = await fetch('/api/analytics/admin/retention', {
          headers: {
            'Authorization': BASIC_AUTH_HEADER,
            'X-Auth-Token': session?.access_token || ''
          }
        });

        if (response.status === 403) {
          document.getElementById('mainContainer').innerHTML = `
            <div class="error-state">
              <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <line x1="12" y1="8" x2="12" y2="12"/>
                <line x1="12" y1="16" x2="12.01" y2="16"/>
              </svg>
              <h2 style="font-size: 1.25rem; color: var(--gray-900);">アクセス権限がありません</h2>
              <p style="color: var(--gray-600);">このページは管理者のみアクセスできます。</p>
              <a href="/create.html" class="back-link" style="margin-top: var(--s-16);">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
                アプリに戻る
              </a>
            </div>
          `;
          return;
        }

        if (!response.ok) {
          throw new Error('リテンションデータの読み込みに失敗しました');
        }

        retentionData = await response.json();
        renderDashboard(retentionData);

        loadingState.style.display = 'none';
        dashboardContent.style.display = 'block';

        document.getElementById('lastUpdated').textContent =
          `最終更新: ${new Date().toLocaleTimeString('ja-JP')}`;
      } catch (err) {
        console.error('リテンションデータの読み込みに失敗:', err);
        loadingState.innerHTML = `
          <div style="text-align: center; color: var(--gray-600);">
            <p>リテンションデータの読み込みに失敗しました</p>
            <button class="apply-btn" onclick="loadRetention()" style="margin-top: var(--s-16);">再試行</button>
          </div>
        `;
      }
    }

    function renderDashboard(data) {
      // Day N Retention Chart
      renderDayRetentionChart(data.dayRetention || {});

      // Stickiness & Active Users
      renderStickiness(data.stickiness || {}, data.activeUsers || {});

      // Cohort Table
      renderCohortTable(data.cohortRetention || []);

      // Lifecycle Segments
      renderLifecycle(data.lifecycle || {});
    }

    function renderDayRetentionChart(dayRetention) {
      const container = document.getElementById('dayRetentionChart');
      const days = ['d1', 'd3', 'd7', 'd14', 'd30'];
      const labels = ['D1', 'D3', 'D7', 'D14', 'D30'];
      const maxValue = 100;

      container.innerHTML = days.map((day, i) => {
        const value = dayRetention[day] || 0;
        const heightPercent = Math.max((value / maxValue) * 100, 5);
        const color = getRetentionColor(value);

        return `
          <div class="retention-bar-wrapper">
            <div class="retention-bar-value">${value.toFixed(1)}%</div>
            <div class="retention-bar-container">
              <div class="retention-bar" style="height: ${heightPercent}%; background: ${color};"></div>
            </div>
            <div class="retention-bar-label">${labels[i]}</div>
          </div>
        `;
      }).join('');
    }

    function renderStickiness(stickiness, activeUsers) {
      // Stickiness value
      const stickinessPercent = stickiness.current || 0;
      document.getElementById('stickinessValue').textContent = `${stickinessPercent.toFixed(1)}%`;
      document.getElementById('stickinessValue').style.color = stickinessPercent >= 20 ? '#10B981' : stickinessPercent >= 10 ? '#F59E0B' : '#EF4444';

      // Active users
      document.getElementById('dauValue').textContent = formatNumber(activeUsers.dau || 0);
      document.getElementById('wauValue').textContent = formatNumber(activeUsers.wau || 0);
      document.getElementById('mauValue').textContent = formatNumber(activeUsers.mau || 0);

      // Trend
      const trendContainer = document.getElementById('stickinessTrend');
      const trend = stickiness.trend || [];

      if (trend.length === 0) {
        trendContainer.innerHTML = '<div class="loading-state">データなし</div>';
        return;
      }

      const maxTrend = Math.max(...trend.map(t => t.value), 1);
      trendContainer.innerHTML = trend.map((t, i) => {
        const heightPercent = Math.max((t.value / maxTrend) * 100, 5);
        const isToday = i === trend.length - 1;
        return `<div class="trend-bar ${isToday ? 'highlight' : ''}" style="height: ${heightPercent}%;" title="${t.date}: ${t.value.toFixed(1)}%"></div>`;
      }).join('');
    }

    function renderCohortTable(cohorts) {
      const tbody = document.getElementById('cohortTableBody');

      if (!cohorts || cohorts.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="loading-state">データなし</td></tr>';
        return;
      }

      tbody.innerHTML = cohorts.map(cohort => {
        const weeks = [cohort.week0, cohort.week1, cohort.week2, cohort.week3, cohort.week4];
        const cells = weeks.map((value, i) => {
          if (value === null || value === undefined) {
            return '<td>-</td>';
          }
          const color = getRetentionColor(value);
          return `<td><span class="cohort-cell" style="background: ${color}20; color: ${color};">${value.toFixed(1)}%</span></td>`;
        }).join('');

        return `
          <tr>
            <td>${formatCohortDate(cohort.cohort)}</td>
            <td class="cohort-size">${formatNumber(cohort.cohortSize)}</td>
            ${cells}
          </tr>
        `;
      }).join('');
    }

    function renderLifecycle(lifecycle) {
      document.getElementById('lifecycleNew').textContent = formatNumber(lifecycle.new || 0);
      document.getElementById('lifecycleActive').textContent = formatNumber(lifecycle.active || 0);
      document.getElementById('lifecycleAtRisk').textContent = formatNumber(lifecycle.atRisk || 0);
      document.getElementById('lifecycleDormant').textContent = formatNumber(lifecycle.dormant || 0);
      document.getElementById('lifecycleResurrected').textContent = formatNumber(lifecycle.resurrected || 0);
    }

    // Utility functions
    function formatNumber(num) {
      if (num === null || num === undefined) return '-';
      return num.toLocaleString('ja-JP');
    }

    function formatCohortDate(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      return date.toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' }) + '週';
    }

    function getRetentionColor(value) {
      if (value >= 40) return '#10B981'; // Green
      if (value >= 25) return '#34D399'; // Light green
      if (value >= 15) return '#F59E0B'; // Yellow
      if (value >= 5) return '#FB923C';  // Orange
      return '#EF4444'; // Red
    }

    function escapeHtml(str) {
      if (!str) return '';
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    // Initialize
    async function init() {
      try {
        await DreamCoreAuth.initAuth();
        const isAuthed = await DreamCoreAuth.isAuthenticated();
        if (!isAuthed) {
          window.location.href = '/';
          return;
        }
        loadRetention();
      } catch (err) {
        console.error('認証の初期化に失敗:', err);
        window.location.href = '/';
      }
    }

    init();

    // Auto-refresh every 60 seconds
    setInterval(() => {
      if (document.visibilityState === 'visible') {
        loadRetention();
      }
    }, 60000);
  </script>
</body>
</html>
