<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PWA Install Test</title>
  <link rel="manifest" href="/manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      padding: 80px 16px 40px;
      background: #f5f5f7;
      color: #1a1a1a;
    }
    h1 { font-size: 22px; margin-bottom: 20px; }
    .card {
      background: #fff;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    .card h2 { font-size: 16px; margin-bottom: 12px; color: #333; }
    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      font-size: 14px;
      border-bottom: 1px solid #f0f0f0;
    }
    .info-row:last-child { border-bottom: none; }
    .info-label { color: #666; }
    .info-value { font-weight: 600; color: #333; }
    .info-value.yes { color: #34C759; }
    .info-value.no { color: #FF3B30; }
    .btn-group { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 12px; }
    .btn {
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }
    .btn-ios { background: #007AFF; color: #fff; }
    .btn-android { background: #34A853; color: #fff; }
    .btn-reset { background: #FF3B30; color: #fff; }
    .btn-dismiss { background: #FF9500; color: #fff; }
    #pwaStatus { font-size: 13px; color: #666; margin-top: 8px; }
  </style>
</head>
<body>
  <h1>PWA Install Prompt Test</h1>

  <div class="card">
    <h2>Device Info</h2>
    <div class="info-row">
      <span class="info-label">User Agent</span>
      <span class="info-value" id="ua" style="font-size:11px;max-width:60%;text-align:right;word-break:break-all"></span>
    </div>
    <div class="info-row">
      <span class="info-label">Platform</span>
      <span class="info-value" id="platform"></span>
    </div>
    <div class="info-row">
      <span class="info-label">Standalone</span>
      <span class="info-value" id="standalone"></span>
    </div>
    <div class="info-row">
      <span class="info-label">iOS</span>
      <span class="info-value" id="isIOS"></span>
    </div>
    <div class="info-row">
      <span class="info-label">Mobile</span>
      <span class="info-value" id="isMobile"></span>
    </div>
  </div>

  <div class="card">
    <h2>PWA Status</h2>
    <div class="info-row">
      <span class="info-label">pwa-installed</span>
      <span class="info-value" id="lsInstalled"></span>
    </div>
    <div class="info-row">
      <span class="info-label">pwa-install-dismissed</span>
      <span class="info-value" id="lsDismissed"></span>
    </div>
    <div id="pwaStatus"></div>
  </div>

  <div class="card">
    <h2>Debug Controls</h2>
    <div class="btn-group">
      <button class="btn btn-ios" onclick="window.__pwaForceShow('ios')">Show iOS Modal</button>
      <button class="btn btn-android" onclick="window.__pwaForceShow('chromium')">Show Android Banner</button>
      <button class="btn btn-reset" onclick="resetPWA()">Reset State</button>
      <button class="btn btn-dismiss" onclick="showDismissState()">Check Dismiss</button>
    </div>
  </div>

  <script src="/pwa-install.js?v=20260206b" defer></script>
  <script>
    function updateInfo() {
      document.getElementById('ua').textContent = navigator.userAgent;
      document.getElementById('platform').textContent = navigator.platform;

      var standalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
      var el = document.getElementById('standalone');
      el.textContent = standalone ? 'Yes' : 'No';
      el.className = 'info-value ' + (standalone ? 'yes' : 'no');

      var ios = /iPad|iPhone|iPod/.test(navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
      el = document.getElementById('isIOS');
      el.textContent = ios ? 'Yes' : 'No';
      el.className = 'info-value ' + (ios ? 'yes' : 'no');

      var mobile = /Android|iPhone|iPad|iPod|webOS|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
      el = document.getElementById('isMobile');
      el.textContent = mobile ? 'Yes' : 'No';
      el.className = 'info-value ' + (mobile ? 'yes' : 'no');

      try {
        document.getElementById('lsInstalled').textContent = localStorage.getItem('pwa-installed') || '(not set)';
        var dismissed = localStorage.getItem('pwa-install-dismissed');
        if (dismissed) {
          var ago = Math.round((Date.now() - parseInt(dismissed, 10)) / 60000);
          document.getElementById('lsDismissed').textContent = ago + ' min ago';
        } else {
          document.getElementById('lsDismissed').textContent = '(not set)';
        }
      } catch (e) {
        document.getElementById('lsInstalled').textContent = 'N/A';
        document.getElementById('lsDismissed').textContent = 'N/A';
      }
    }

    function resetPWA() {
      try {
        localStorage.removeItem('pwa-installed');
        localStorage.removeItem('pwa-install-dismissed');
      } catch (e) { /* ignore */ }
      updateInfo();
      document.getElementById('pwaStatus').textContent = 'State reset. Reload page to test auto-show.';
    }

    function showDismissState() {
      updateInfo();
      try {
        var dismissed = localStorage.getItem('pwa-install-dismissed');
        if (dismissed) {
          var remaining = 7 * 24 * 60 - Math.round((Date.now() - parseInt(dismissed, 10)) / 60000);
          document.getElementById('pwaStatus').textContent = remaining > 0
            ? 'Dismissed. Will re-appear in ~' + Math.round(remaining / 60) + ' hours.'
            : 'Dismiss period expired. Banner will show on next visit.';
        } else {
          document.getElementById('pwaStatus').textContent = 'Not dismissed.';
        }
      } catch (e) {
        document.getElementById('pwaStatus').textContent = 'Cannot access localStorage.';
      }
    }

    // Use MutationObserver to detect when pwa-install.js adds the banner
    var observer = new MutationObserver(function () {
      var banner = document.querySelector('.pwa-install-banner');
      if (banner) {
        document.getElementById('pwaStatus').textContent = 'Banner auto-shown!';
        observer.disconnect();
      }
    });

    document.addEventListener('DOMContentLoaded', function () {
      updateInfo();
      observer.observe(document.body, { childList: true });
      // Cleanup observer after 10 seconds if banner never appeared
      setTimeout(function () {
        observer.disconnect();
      }, 10000);
    });
  </script>
</body>
</html>
